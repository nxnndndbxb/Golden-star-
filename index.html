
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Star ‚≠ê | Digital Wealth Platform</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- [V16] Golden Star / Cleaned & Refined Theme --- */
        :root {
            /* Core Palette (Kept for Dark Background) */
            --background-primary: #04081c;   /* Deeper, richer space blue */
            --background-secondary: #0c1232; /* Richer, lighter space blue for surfaces */
            --text-primary: #f0f8ff;         /* Star White */
            --text-secondary: rgba(240, 248, 255, 0.7); /* Faded starlight */
            
            /* Accents (GOLDEN) */
            --primary-accent: #FFC300;       /* Rich Gold */
            --secondary-accent: #B8860B;     /* Dark Golden Rod */
            --tertiary-accent: #FFEC80;      /* Light Gold Highlight */
            --text-on-accent: #000000;       /* Text color for dark/vibrant buttons (changed to black for gold) */
            
            /* Functional Colors */
            --success-color: #10b981;        /* Emerald Green (Keep for positive TX) */
            --danger-color: #ef4444;         /* Bright Red */
            --warning-color: #f59e0b;        /* Amber Orange (Used for timers) */
            
            /* Surface & Layering (Refined Glassmorphism) */
            --surface-bg: rgba(18, 24, 46, 0.65); /* Translucent Frosted Indigo Glass */
            --surface-bg-darker: rgba(0, 0, 0, 0.3); /* Darker surface for contrast */
            --surface-border: rgba(255, 195, 0, 0.25); /* Faint Gold */
            --surface-highlight: rgba(255, 195, 0, 0.15);
            --shadow-glow: 0 0 20px rgba(255, 195, 0, 0.4);
            --shadow-panel: 0 10px 40px rgba(0, 0, 0, 0.6);
            
            /* General */
            --font-family: 'Poppins', sans-serif;
            --border-radius: 28px;
            --transition-speed: 0.4s;
            --member-color: #4287f5; /* Blue color for members */
            
            /* [NEW] Auth-Specific Variables for High-Security Look */
            --auth-panel-radius: 10px 40px 10px 40px; /* Asymmetric Bevel */
            --auth-input-radius: 8px; /* Sharper input corners */
            --auth-glow: 0 0 10px rgba(255, 195, 0, 0.8), 0 0 20px rgba(255, 195, 0, 0.5);
            --auth-shadow-dark: 0 15px 50px rgba(0, 0, 0, 0.9);
        }

        /* --- General & Body Styling --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-family);
            background-color: transparent; 
            color: var(--text-primary);
            padding-bottom: 120px;
            overflow-x: hidden;
            position: relative;
        }
        
        body.landing-visible { padding-bottom: 0; }
        h1, h2, h3, h4 { color: var(--text-primary); }

        /* --- Animated Backgrounds (Modified for Image & Deeper Color) --- */
        #background-effects { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -2; 
            overflow: hidden; 
            background-image: url('https://iili.io/KPwbioF.jpg'); /* Space Nebula Image (UPDATED) */
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: var(--background-primary); 
        }
        .aurora-background { 
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; 
            background: radial-gradient(ellipse at 20% 25%, hsla(40, 100%, 70%, 0.2), transparent 50%), /* Gold Tint */
                        radial-gradient(ellipse at 80% 75%, hsla(271, 80%, 65%, 0.3), transparent 60%); 
            animation: aurora-flow 35s infinite alternate ease-in-out; 
        }
        @keyframes aurora-flow { from { transform: rotate(0deg) scale(1.3); opacity: 0.8;} to { transform: rotate(15deg) scale(1.3); opacity: 1;} }

        /* --- Preloader (Unchanged) --- */
        #preloader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--background-primary); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
        #preloader.hidden { opacity: 0; visibility: hidden; }
        .spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid rgba(255, 195, 0, 0.2); border-top-color: var(--primary-accent); animation: spin-loader 1s linear infinite; }
        @keyframes spin-loader { to { transform: rotate(360deg); } }

        /* --- Custom Logo Styling (NEW) --- */
        .app-logo-link {
            font-size: 1.8em; 
            font-weight: 700; 
            color: var(--text-primary); 
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .logo-icon { 
            color: var(--primary-accent); 
            margin-right: 8px; 
            text-shadow: 0 0 10px var(--primary-accent), 0 0 20px rgba(255, 195, 0, 0.5); /* Stronger glow */
            font-size: 1.2em; /* Slightly larger icon */
            animation: pulse-glow 3s infinite ease-in-out alternate;
        }
        .star-emoji {
            margin-left: 5px;
            font-size: 1.1em;
        }
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 8px var(--primary-accent), 0 0 15px rgba(255, 195, 0, 0.3); }
            100% { text-shadow: 0 0 15px var(--tertiary-accent), 0 0 30px rgba(255, 195, 0, 0.7); }
        }
        /* End Custom Logo Styling */

        /* --- [NEW] Landing Page Styles (Kept as is) --- */
        #landing-page-container { display: block; width: 100%; overflow-x: hidden; padding: 0 20px; }
        .landing-header { position: fixed; top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; z-index: 1500; background: transparent; transition: background 0.3s ease, box-shadow 0.3s ease; }
        .landing-header.scrolled { background: var(--background-primary); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 5px 25px rgba(0,0,0,0.7); }
        .landing-hero { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 100px 0; }
        .landing-hero h1 { 
            font-size: clamp(2.5rem, 6vw, 5rem); 
            font-weight: 900; 
            line-height: 1.1; 
            margin-bottom: 25px; 
            background: linear-gradient(90deg, var(--text-primary) 20%, var(--primary-accent) 50%, var(--secondary-accent) 80%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            animation: text-glow-v2 6s ease-in-out infinite alternate; 
            text-shadow: 0 0 15px rgba(255, 195, 0, 0.5);
        }
        @keyframes text-glow-v2 { 
            0% { filter: brightness(1.0); text-shadow: 0 0 10px rgba(255, 195, 0, 0.4); } 
            100% { filter: brightness(1.2); text-shadow: 0 0 25px rgba(255, 195, 0, 0.8), 0 0 40px rgba(184, 134, 11, 0.4); } 
        }
        .landing-hero p { font-size: clamp(1rem, 2.5vw, 1.3rem); color: var(--text-secondary); max-width: 800px; margin-bottom: 50px; line-height: 1.7; }
        .enter-app-btn { padding: 20px 40px; font-size: 1.2em; }
        .scroll-down-indicator { position: absolute; bottom: 40px; font-size: 1.5em; color: var(--primary-accent); animation: bounce-indicator 2s infinite; opacity: 0.8; }
        .scroll-down-indicator i { display: block; }
        @keyframes bounce-indicator { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-8px); } }
        .landing-section { padding: 120px 0; max-width: 1200px; margin: 0 auto; opacity: 0; transform: translateY(50px); transition: opacity 1s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .landing-section.visible { opacity: 1; transform: translateY(0); }
        .landing-section-header { text-align: center; margin-bottom: 70px; }
        .landing-section-header h2 { font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 800; margin-bottom: 15px; background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .landing-section-header p { font-size: 1.1em; color: var(--text-secondary); max-width: 700px; margin: 0 auto; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .feature-card { 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            border-radius: var(--border-radius); 
            padding: 40px; 
            backdrop-filter: blur(18px); 
            -webkit-backdrop-filter: blur(18px); 
            text-align: center; 
            transition: all var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: var(--shadow-panel);
        }
        .feature-card:hover { 
            transform: translateY(-12px); 
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8), var(--shadow-glow); 
            border-color: var(--primary-accent); 
        }
        .feature-icon { 
            font-size: 4em; 
            margin-bottom: 25px; 
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 0 15px rgba(255, 195, 0, 0.7);
        }
        .feature-card h3 { font-size: 1.8em; font-weight: 700; margin-bottom: 15px; }
        .feature-card p { color: var(--text-secondary); line-height: 1.8; }
        .feature-card .highlight { 
            display: inline-block; 
            margin-top: 25px; 
            padding: 12px 25px; 
            background: var(--surface-highlight); 
            border: 1px solid var(--surface-border); 
            border-radius: 18px; 
            font-weight: 600; 
            color: var(--primary-accent);
            text-shadow: 0 0 5px rgba(255, 195, 0, 0.5);
            font-size: 0.95em;
        }

        /* --- Main App Containers & Page Transitions (Kept as is) --- */
        #app-container {
            display: none; /* Hidden by default, shown after successful login */
        }
        #app-container.active {
            display: block;
        }
        .page { 
            display: none; 
            padding: 25px 20px; 
            padding-top: 95px; /* Adjusted for new fixed app-header */
            padding-bottom: 120px; /* Space for bottom-nav */
            animation: pageFadeIn 0.8s cubic-bezier(0.165, 0.84, 0.44, 1); 
            min-height: calc(100vh - 120px); 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .page.active { display: block; }
        @keyframes pageFadeIn { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .page-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 30px; 
            margin-top: -30px; /* Pull up to account for the overall page padding */
        }
        .page-header .back-btn { background: none; border: none; font-size: 1.5em; color: var(--primary-accent); cursor: pointer; margin-right: 15px; transition: transform 0.2s ease; }
        .page-header .back-btn:hover { transform: translateX(-5px); }
        .page-header h3 { flex-grow: 1; font-weight: 700; font-size: 1.8em; color: var(--text-primary); }

        /* --- New App Header for Menu/Sidebar (Kept as is) --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: none; /* Hidden by default, shown on login */
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 1050; /* Above bottom-nav (1000) and telegram-fab (1001) */
            background: var(--background-primary);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 3px 15px rgba(0,0,0,0.6);
            height: 70px; /* Fixed height for consistency */
        }
        .app-header .logo-text {
            /* The .app-logo-link styles apply here */
            font-size: 1.5em; /* Slightly smaller in header */
        }
        .app-header .logo-text .logo-icon {
            font-size: 1em;
        }
        .menu-btn {
            background: var(--background-secondary);
            border: none;
            color: var(--text-primary);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 1px solid var(--surface-border);
        }
        .menu-btn:hover {
            background: var(--surface-highlight);
            color: var(--primary-accent);
            transform: scale(1.05);
        }

        /* --- Sliding Sidebar/Menu (Kept as is) --- */
        #app-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 300px;
            max-width: 80vw;
            background: var(--surface-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 2px solid var(--surface-border);
            z-index: 2500;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 20px;
            padding-top: 90px;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }
        #app-sidebar.active {
            transform: translateX(0);
        }
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2400;
            display: none;
        }
        #app-sidebar.active ~ #sidebar-overlay {
            display: block;
        }
        .sidebar-user-info {
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--surface-border);
        }
        .sidebar-action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-action-list li {
            margin-bottom: 10px;
        }
        .sidebar-action-list button {
            width: 100%;
            display: flex;
            align-items: center;
            background: var(--background-secondary);
            border: none;
            border-radius: 18px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }
        .sidebar-action-list button:hover {
            background: var(--surface-highlight);
            color: var(--primary-accent);
            transform: translateX(5px);
        }
        .sidebar-action-list button i {
            font-size: 1.5em;
            width: 30px;
            margin-right: 15px;
        }
        .sidebar-action-list button.logout-btn i { color: var(--danger-color); }
        .sidebar-action-list button.history-btn i { color: var(--member-color); } /* NEW History Icon Color */
        .sidebar-action-list button.nft-btn i { color: var(--primary-accent); }
        .sidebar-action-list button.sell-products-btn i { color: var(--secondary-accent); }
        .sidebar-action-list button.free-mining-btn i { color: var(--success-color); }
        .sidebar-action-list button.about-btn i { color: var(--tertiary-accent); }
        .sidebar-action-list button.security-btn i { color: var(--primary-accent); }

        /* --- Content Panel Component (High-Quality Glassmorphism) - Kept for general app content --- */
        .content-panel { 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            border-radius: var(--border-radius); 
            padding: 30px; 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            box-shadow: var(--shadow-panel); 
            margin-bottom: 25px; 
            position: relative; 
            overflow: hidden; 
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; 
        }
        .content-panel:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.7), var(--shadow-glow); 
        }
        .content-panel h3 { 
            font-weight: 700; 
            font-size: 1.6em; 
            background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--surface-border); 
        }

        /* --- [HIGH SECURITY LOOK] Auth Pages --- */
        #auth-container { display: none; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        #auth-container.active { display: flex; }
        .auth-form { width: 100%; max-width: 450px; }
        
        /* OVERRIDE: High Security Panel Style */
        .auth-form .content-panel {
            /* NEW SECURITY LOOK STYLES: Angular, Vault-like */
            border-radius: var(--auth-panel-radius); /* Asymmetric Bevel */
            border: 2px solid var(--primary-accent); /* Stronger Border */
            box-shadow: var(--auth-shadow-dark); 
            background: rgba(4, 8, 28, 0.85); /* Less translucent, more vault-like */
            backdrop-filter: blur(5px); /* Reduce blur */
            -webkit-backdrop-filter: blur(5px);
            padding: 40px; /* Increase padding for a bolder feel */
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .auth-form .content-panel:hover {
            transform: translateY(-5px); 
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.9), var(--auth-glow);
        }

        /* OVERRIDE: Icon Glow */
        .auth-icon { 
            font-size: 6.5em; 
            text-shadow: 0 0 40px rgba(255, 195, 0, 1), 0 0 80px rgba(255, 195, 0, 0.5); /* Super strong glow */
            margin-bottom: 40px; 
            animation: auth-icon-float 6s ease-in-out infinite, pulse-glow-strong 1.5s infinite alternate; 
            background: linear-gradient(45deg, var(--tertiary-accent), var(--primary-accent));
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        @keyframes pulse-glow-strong {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.05); opacity: 1; }
        }
        @keyframes auth-icon-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        /* OVERRIDE: Header/Title (Changed to center the auth title) */
        .auth-form h2 { 
            text-align: center; /* ALIGNMENT CHANGE: Center the header/title */
            font-weight: 800; 
            font-size: 3.5em; /* Bigger Title */
            margin-bottom: 40px; /* More space */
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-accent);
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); 
        }

        /* OVERRIDE: Input Fields (MODIFIED for icon swap) */
        .input-group { position: relative; margin-bottom: 30px; }
        /* Static Icon (Lock/Envelope) - MOVED TO RIGHT */
        .input-group i.fa-solid { 
            position: absolute; 
            right: 25px; /* MOVED TO RIGHT */
            left: auto;  /* Ensure it's not fighting 'left: 25px' */
            top: 50%; transform: translateY(-50%); 
            color: var(--text-secondary); transition: color var(--transition-speed) ease; 
            font-size: 1.2em;
            /* Ensure the toggle doesn't inherit these if it is a .fa-solid */
        }
        /* Password Toggle Icon - MOVED TO LEFT */
        .input-group .toggle-password { 
            position: absolute; /* Re-add to ensure proper positioning */
            left: 25px; /* MOVED TO LEFT */
            right: auto; 
            top: 50%; transform: translateY(-50%); /* Re-add for centering */
            cursor: pointer; color: var(--text-secondary); 
            transition: color 0.3s ease; 
            z-index: 2; /* Ensure it's above the input text */
        }
        .input-group input, .modal-content select { 
            /* Changed to accommodate static icon on RIGHT (default) */
            width: 100%; 
            padding: 22px 60px 22px 20px; /* Increased right padding for static icon */
            border: 2px solid var(--surface-border); 
            border-radius: var(--auth-input-radius); 
            background-color: var(--background-secondary); 
            color: var(--text-primary); 
            font-family: var(--font-family); 
            font-size: 1em; 
            transition: all var(--transition-speed) ease; 
        }
        .input-group input[type="password"] {
             /* Added left padding for the toggle icon (now on the left) */
             padding-left: 60px; 
             padding-right: 60px; /* Keep right padding for the static icon */
        }
        /* Make sure other inputs also have the correct padding */
        .input-group input:not([type="password"]) {
             padding-left: 20px; /* No toggle icon on the left */
        }
        .input-group input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .input-group input:focus { 
            /* System Scan/Access Look */
            outline: none; 
            border-color: var(--primary-accent); 
            box-shadow: 0 0 30px rgba(255, 195, 0, 0.8), inset 0 0 5px rgba(255, 195, 0, 0.4); /* Inset for depth */
            background-color: var(--background-primary); 
        }
        .input-group input:focus ~ i.fa-solid { color: var(--primary-accent); }
        
        /* OVERRIDE: Buttons (Kept as is) */
        .btn { 
            /* Angular/Geometric Button */
            display: inline-flex; justify-content: center; align-items: center; 
            padding: 22px; /* Bigger button */
            border: none; 
            border-radius: 12px 0 18px 0; /* Asymmetric, angular look */
            color: var(--text-on-accent); 
            background: linear-gradient(90deg, #B8860B, #FFC300, #B8860B); /* Horizontal scan effect gradient */
            background-size: 300% auto;
            font-size: 1.2em; /* Bigger text */
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); 
            position: relative; overflow: hidden; 
            box-shadow: 0 8px 30px -8px rgba(255, 195, 0, 0.5); 
            text-transform: uppercase; letter-spacing: 1px; text-decoration: none; width: auto; 
            border: 2px solid var(--tertiary-accent);
        }
        .btn.full-width { width: 100%; }
        .btn:hover:not(:disabled) { 
            /* Faster, more aggressive hover */
            transform: translateY(-5px) scale(1.01); 
            box-shadow: 0 15px 40px -8px rgba(255, 195, 0, 0.8), var(--auth-glow); 
            background-position: right center; 
        }
        /* End High Security Look Overrides */


        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); box-shadow: none; background: var(--background-secondary); border: 2px solid var(--surface-border); }
        .btn .btn-text { transition: opacity 0.2s ease; }
        .btn .spinner-sm { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.3); border-top-color: var(--text-on-accent); border-radius: 50%; animation: spin-loader 0.8s linear infinite; opacity: 0; transition: opacity 0.2s ease; }
        .btn.loading .btn-text { opacity: 0; }
        .btn.loading .spinner-sm { opacity: 1; }
        .auth-switch { text-align: center; margin-top: 25px; color: var(--text-secondary); }
        .auth-switch a { color: var(--primary-accent); text-decoration: none; font-weight: 600; transition: color 0.3s ease; }
        .auth-switch a:hover { color: var(--text-primary); }
        
        /* MODIFIED Recharge/Withdrawal Button Styles (Kept as is) */
        .wallet-actions { 
            display: flex; 
            flex-direction: column; /* Stack vertically on small screens */
            gap: 15px; 
            margin-top: 25px; 
        }
        .wallet-actions .btn { 
            flex: 1; 
            padding: 15px 20px; 
            font-size: 1.1em; 
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 14px; 
            border: none; /* Remove angular border for internal buttons */
        }
        .btn-buy { background: linear-gradient(45deg, var(--success-color), #4ade80); color: white; box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-sell { background: linear-gradient(45deg, var(--danger-color), #f87171); color: white; box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); }
        
        @media (min-width: 650px) {
            .wallet-actions {
                flex-direction: row;
                gap: 20px;
            }
        }
        /* END MODIFIED Button Styles */

        /* --- Bottom Navigation Bar (Floating Dock) - Kept as is) --- */
        .bottom-nav { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 40px); max-width: 500px; height: 85px; 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); 
            display: flex; justify-content: space-around; align-items: center; 
            border-radius: calc(var(--border-radius) + 10px); 
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), var(--shadow-glow); 
            z-index: 1000; 
            padding: 0 10px;
        }
        .nav-btn { 
            background: none; border: none; color: var(--text-secondary); 
            display: flex; flex-direction: column; align-items: center; 
            font-size: 0.8em; font-weight: 500; cursor: pointer; 
            transition: all var(--transition-speed) ease; position: relative; 
            padding: 8px 5px; width: 70px; 
        }
        .nav-btn i { font-size: 1.8em; margin-bottom: 5px; }
        .nav-btn.active { color: var(--text-primary); transform: translateY(-8px); }
        .nav-btn.active i { 
            color: var(--primary-accent); 
            text-shadow: 0 0 10px var(--primary-accent);
        }
        .nav-btn::before { 
            content: ''; position: absolute; top: 0; 
            width: 80%; height: 3px; 
            background: linear-gradient(90deg, transparent, var(--primary-accent), transparent);
            border-radius: 0 0 5px 5px;
            transform: scaleX(0); 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 10px var(--primary-accent);
        }
        .nav-btn.active::before { transform: scaleX(1); }

        /* --- Draggable Floating Telegram Button - Kept as is --- */
        .telegram-fab { 
            position: fixed; bottom: 120px; right: 25px; 
            width: 65px; height: 65px; 
            background: linear-gradient(45deg, #FFC300, #B8860B); /* Golden gradient */
            color: var(--background-primary); border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2em; text-decoration: none; 
            box-shadow: 0 8px 30px rgba(255, 195, 0, 0.4), 0 0 15px rgba(255, 195, 0, 0.6); 
            z-index: 1001; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            user-select: none; -webkit-user-select: none; cursor: grab; 
            transform: scale(0); 
            animation: fab-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 1.5s forwards; 
        }
        .telegram-fab.dragging { cursor: grabbing; transition: none; box-shadow: 0 12px 35px rgba(255, 195, 0, 0.6); }
        .telegram-fab:hover:not(.dragging) { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 195, 0, 0.8); }
        @keyframes fab-pop-in { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- Home Page (Kept as is) --- */
        .header-welcome { text-align: center; margin-bottom: 30px; }
        .header-welcome h2 { font-size: 2.5em; font-weight: 800; line-height: 1.2; color: var(--text-primary)}
        .header-welcome p { color: var(--text-secondary); font-weight: 300; font-size: 1.1em; }
        
        /* --- General Stats, Trade, Wallet, etc. (Kept as is) --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { 
            background: var(--background-secondary); 
            border-radius: 20px; padding: 25px; text-align: center; 
            border: 1px solid var(--surface-border); 
            transition: all var(--transition-speed) ease; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .stat-card:hover { border-color: var(--primary-accent); transform: scale(1.03) translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.6), 0 0 15px rgba(255, 195, 0, 0.4); background: var(--surface-bg);}
        .stat-card .label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; color: var(--text-primary); }
        .balance-display { text-align: center; margin-bottom: 30px; }
        .balance-display .amount { 
            font-size: 4.5em; font-weight: 800; line-height: 1.1; 
            background: linear-gradient(90deg, var(--text-primary), var(--primary-accent)); 
            -webkit-background-clip: text; background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 20px rgba(255, 195, 0, 0.3); 
        }
        .balance-display .currency { color: var(--text-secondary); font-weight: 400; font-size: 1.2em; margin-left: 5px; }
        .balance-on-hold { text-align: center; color: var(--warning-color); font-size: 1em; margin-top: -15px; margin-bottom: 30px; font-weight: 600; }
        .trade-form input, .modal-content select { padding: 20px; }
        
        /* --- Ranking Page Styles (Revamped Style) --- */
        #ranking-page h3 { background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .ranking-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background-color: var(--background-secondary); border-radius: 14px; border-left: 5px solid var(--primary-accent); transition: background-color 0.3s ease, transform 0.3s ease; }
        .ranking-item:hover { background-color: var(--surface-bg-darker); transform: translateX(3px); }
        .ranking-item .rank-num { 
            font-size: 1.8em; /* Larger number */
            font-weight: 800; 
            width: 15%; 
            text-align: center; 
            color: var(--primary-accent); 
        }
        .ranking-item .rank-num.top-3 { 
            color: var(--tertiary-accent); 
            font-size: 2.2em; 
            text-shadow: 0 0 15px var(--tertiary-accent);
        }
        .ranking-item .user-info { width: 40%; } /* Adjusted width */
        .ranking-item .user-info .username { font-weight: 600; font-size: 1.1em; color: var(--text-primary); }
        .ranking-item .user-info .uid { font-size: 0.8em; color: var(--text-secondary); }
        .ranking-item .net-worth { font-size: 1.4em; font-weight: 700; width: 45%; text-align: right; color: var(--success-color); }
        .ranking-header-row { font-size: 0.9em; } /* Adjusted size */
        /* --- END Ranking Page Styles --- */

        /* --- History List & General Styles (Kept as is) --- */
        @keyframes reward-pulse-green { 0% { text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); } 50% { text-shadow: 0 0 20px rgba(16, 185, 129, 0.7); } 100% { text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); } }
        .history-list { list-style-type: none; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .transaction-item { display: flex; align-items: center; padding: 18px; margin-bottom: 12px; background-color: var(--background-secondary); border-radius: 16px; border-left: 5px solid var(--text-secondary); transition: background-color 0.3s ease, transform 0.3s ease; }
        .transaction-item:hover { background-color: var(--surface-bg-darker); transform: translateX(3px); }
        /* Transaction colors remain distinct */
        .transaction-item.buy, .transaction-item.deposit, .transaction-item.plan_profit, .transaction-item.invite_bonus, .transaction-item.nft_profit { border-left-color: var(--success-color); }
        .transaction-item.sell, .transaction-item.withdrawal, .transaction-item.nft_purchase, .transaction-item.plan_invest { border-left-color: var(--danger-color); }
        .transaction-item.pending { border-left-color: var(--warning-color); opacity: 0.9; } /* Slightly less opacity for clarity */
        .transaction-item.rejected { border-left-color: var(--danger-color); opacity: 0.7; } /* Faded red for rejected */
        .transaction-item.approved { border-left-color: var(--success-color); opacity: 1.0; } /* Strong green for approved/completed */
        .transaction-item.bonus { border-left-color: var(--primary-accent); }
        .transaction-item .icon { font-size: 1.8em; width: 40px; text-align: center; margin-right: 15px; }
        .transaction-item.buy .icon, .transaction-item.deposit .icon, .transaction-item.plan_profit .icon, .transaction-item.invite_bonus .icon, .transaction-item.nft_profit .icon { color: var(--success-color); }
        .transaction-item.sell .icon, .transaction-item.withdrawal .icon, .transaction-item.nft_purchase .icon, .transaction-item.plan_invest .icon { color: var(--danger-color); }
        .transaction-item.bonus .icon { color: var(--primary-accent); }
        .transaction-item.pending .icon { color: var(--warning-color); }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .type { font-weight: 600; text-transform: capitalize; color: var(--text-primary); font-size: 1.1em;}
        .transaction-item .date { font-size: 0.85em; color: var(--text-secondary); }
        .transaction-item .amount { font-size: 1.2em; font-weight: 700; text-align: right; color: var(--text-primary); }

        /* --- Beautiful Profile Page (Kept as is) --- */
        .profile-header { text-align: center; margin-bottom: 30px; }
        .profile-avatar { 
            width: 110px; height: 110px; border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent)); 
            display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 20px; 
            box-shadow: 0 0 30px rgba(255, 195, 0, 0.7), 0 0 50px rgba(184, 134, 11, 0.4); 
            border: 4px solid var(--background-primary);
        }
        .profile-avatar i { font-size: 4em; color: var(--background-primary); }
        .profile-header h2 { font-size: 2em; font-weight: 800; margin-bottom: 5px; }
        .profile-header p { color: var(--text-secondary); font-size: 1em; font-family: 'Courier New', monospace; }
        #profile-page .profile-actions-grid {
            display: none;
        }

        /* --- Invite Page (Blockchain Network) - MODIFIED --- */
        .invite-box { text-align: center; }
        .invite-box .icon { font-size: 5em; margin: 20px 0; color: var(--primary-accent); text-shadow: 0 0 25px rgba(255, 195, 0, 0.6);}
        .invite-box p { color: var(--text-secondary); line-height: 1.8; margin-bottom: 25px; font-size: 1.05em;}
        .invite-code { 
            background-color: var(--surface-bg-darker); 
            padding: 25px; border-radius: 18px; 
            border: 2px dashed var(--surface-border); 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 1.2em; margin: 25px 0; 
            word-wrap: break-word; text-align: center; 
            color: var(--primary-accent); font-weight: bold; 
            transition: all 0.3s ease;
        }
        .invite-code:hover { border-color: var(--tertiary-accent); }
        .bonus-display { text-align: center; margin-bottom: 30px; }
        .bonus-display .label { text-transform: uppercase; letter-spacing: 1px; font-size: 1em; color: var(--text-secondary); margin-bottom: 10px; }
        .bonus-display .amount { font-size: 3.5em; font-weight: 800; color: var(--success-color); animation: reward-pulse-green 2s infinite; }
        
        /* --- [NEW DYNAMIC] Network Styles (Simplified for Mobile/Dynamic Rendering) --- */
        .dynamic-network-container {
            padding: 20px 0;
            margin-top: 30px;
            text-align: center;
        }
        .network-root-node {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            border-radius: 50%;
            background-color: var(--primary-accent);
            color: var(--background-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: 700;
            box-shadow: 0 0 25px rgba(255, 195, 0, 0.7);
            position: relative;
            z-index: 10;
            border: 3px solid var(--text-primary);
        }
        .network-root-node i {
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        /* Vertical line connecting root to first level */
        .network-root-node::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            width: 3px;
            height: 30px;
            background-color: var(--primary-accent);
            box-shadow: 0 0 10px var(--primary-accent);
        }
        /* Container for all level cards - adds top margin to account for root node line */
        #network-levels-container {
            padding-top: 30px; 
        }

        .network-level-card {
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 25px;
            backdrop-filter: blur(15px); 
            box-shadow: var(--shadow-panel);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .network-level-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), 0 0 10px rgba(255, 195, 0, 0.4);
        }
        .network-level-card h4 {
            font-size: 1.4em;
            margin-bottom: 10px;
            color: var(--text-primary);
            text-shadow: 0 0 5px rgba(255, 195, 0, 0.3);
            text-align: left;
        }
        .network-level-card .stat-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
        }
        .network-level-card .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--success-color);
        }
        .network-level-card .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        .network-level-card.direct {
            border-left: 5px solid var(--primary-accent);
        }
        .network-level-card.indirect {
            border-left: 5px solid var(--member-color);
        }
        /* Connection Line to Next Card */
        .network-level-card::after {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 50%;
            width: 3px;
            height: 25px;
            background-color: var(--member-color);
            transform: translateX(-50%);
        }
        /* Last card has no line */
        #network-levels-container .network-level-card:last-child::after {
            content: none;
        }
        
        /* Modal List Items - For showing members on click */
        .modal-member-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--background-secondary);
            border-radius: 14px;
            border-left: 4px solid var(--member-color);
            transition: background-color 0.3s ease;
        }
        .modal-member-item:hover {
            background-color: var(--surface-highlight);
        }
        .modal-member-item .user-icon {
            font-size: 1.5em;
            width: 30px;
            margin-right: 15px;
            color: var(--primary-accent);
        }
        .modal-member-item .member-details {
            flex-grow: 1;
            text-align: left;
        }
        .modal-member-item .member-details .username-label {
            font-weight: 600;
            font-size: 1.1em;
            word-break: break-all;
        }
        .modal-member-item .member-details .email-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .modal-member-item .joined-date {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: right;
            min-width: 80px;
        }
        /* --- END DYNAMIC Network Styles --- */

        /* Force hide old network styles (Cleanup) */
        .network-tree-simple, .hex-shape, .level-1-children, .l1-branch-container, .l1-hex-wrapper, .line-l1-horizontal, .line-l1-v-left, .line-l1-v-right, .hex-shape.you, .hex-shape.member, .hex-shape.empty {
            display: none !important; 
        }

        
        /* --- NFT Page Styles (Kept as is) --- */
        #nft-page h3 { background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .nft-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .nft-card { 
            background: var(--surface-bg); border: 2px solid var(--surface-border); border-radius: 20px; 
            padding: 30px; text-align: center; transition: all var(--transition-speed) ease; 
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nft-card:hover { transform: translateY(-10px); box-shadow: 0 15px 50px rgba(0,0,0,0.6); }
        .nft-card .nft-visual { 
            width: 130px; height: 130px; margin: 0 auto 25px; 
            border-radius: 25px; display: flex; justify-content: center; align-items: center; 
            font-size: 4.5em; 
            border: 4px solid var(--background-primary);
        }
        .nft-card h4 { font-size: 1.6em; font-weight: 700; margin-bottom: 10px; }
        .nft-card .price-range { font-size: 1.2em; font-weight: 500; color: var(--warning-color); margin-bottom: 25px; }
        .nft-details { list-style-type: none; margin-bottom: 25px; text-align: left; background-color: var(--surface-bg-darker); padding: 20px; border-radius: 16px; }
        .nft-details li { padding: 10px 0; display: flex; justify-content: space-between; border-bottom: 1px dashed var(--background-secondary); font-size: 1em; }
        .nft-details li:last-child { border-bottom: none; }
        .nft-details li span:first-child { color: var(--text-secondary); }
        .nft-details li span:last-child { font-weight: 600; color: var(--primary-accent); }
        .nft-card .btn { margin-top: 20px; }
        /* NFT Card Specific Colors */
        #nft-bronze { border-color: #cd7f32; }
        #nft-bronze .nft-visual { background: linear-gradient(45deg, #a96628, #cd7f32); box-shadow: 0 0 25px #cd7f32; color: #fff; }
        #nft-silver { border-color: #c0c0c0; }
        #nft-silver .nft-visual { background: linear-gradient(45deg, #a0a0a0, #c0c0c0); box-shadow: 0 0 25px #c0c0c0; color: var(--background-primary); }
        #nft-gold { border-color: #FFC300; }
        #nft-gold .nft-visual { background: linear-gradient(45deg, #e4a11b, #FFC300); box-shadow: 0 0 25px #FFC300; color: var(--background-primary); }
        
        /* --- Plan Card Styling (Kept as is) --- */
        .plan-series-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 20px; 
        }
        
        .plan-card {
             background: var(--surface-bg); border: 2px solid var(--surface-border); border-radius: 20px; 
            padding: 25px; 
            text-align: center; transition: all var(--transition-speed) ease; 
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-color: var(--primary-accent);
        }
        .plan-card:hover { transform: translateY(-10px); box-shadow: 0 15px 50px rgba(0,0,0,0.6); border-color: var(--primary-accent); }
        .plan-card h4 { font-size: 1.4em; font-weight: 700; margin-bottom: 8px; }
        .plan-card .plan-price { font-size: 1em; font-weight: 500; color: var(--warning-color); margin-bottom: 15px; }
        .plan-card .plan-visual { 
            width: 70px; height: 70px; margin: 0 auto 20px; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 2em; 
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));
            color: var(--background-primary);
            box-shadow: 0 0 15px var(--primary-accent);
        }
        .plan-card .nft-details li { padding: 8px 0; font-size: 0.9em; }

        /* --- My NFTs Page Styles (Kept as is) --- */
        .my-nft-card { background: var(--surface-bg-darker); border-radius: 20px; padding: 25px; margin-bottom: 20px; border-left: 6px solid; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .my-nft-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .my-nft-card-header h4 { margin: 0; font-size: 1.4em; font-weight: 700; }
        .my-nft-card-header .investment { font-size: 1.2em; font-weight: 700; }
        .nft-profit-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: center; }
        .nft-profit-details .label { font-size: 0.9em; color: var(--text-secondary); }
        .nft-profit-details .value { font-size: 1.3em; font-weight: 700; color: var(--text-primary); }
        .nft-timer { font-weight: 600; color: var(--warning-color); text-align: center; margin-bottom: 20px; font-size: 1.1em; }
        .nft-progress-bar { width: 100%; height: 12px; background-color: var(--background-secondary); border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .nft-progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary-accent), var(--success-color)); border-radius: 6px; transition: width 0.5s ease; }
        .nft-progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary-accent), var(--success-color)); border-radius: 6px; transition: width 0.5s ease; }
        .my-nft-card .btn { margin-top: 20px; }

        /* --- Modals, Toast, etc. (Kept as is) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(4, 8, 28, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            z-index: 2000; display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease; 
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { 
            width: calc(100% - 40px); max-width: 450px; 
            transform: scale(0.9) translateY(50px); 
            transition: transform var(--transition-speed) cubic-bezier(0.165, 0.84, 0.44, 1);
            max-height: 90vh; 
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        /* Modal content panel inherits from the general .content-panel (rounded) not the auth panel (angular) */
        .modal-content.content-panel { 
            border-radius: var(--border-radius); 
            border: 1px solid var(--surface-border);
            box-shadow: var(--shadow-panel);
            background: var(--surface-bg);
            padding: 30px;
        }
        .option-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; background-color: var(--surface-bg-darker); padding: 8px; border-radius: 20px; }
        .option-btn { padding: 15px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .option-btn.active { background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); color: var(--text-on-accent); box-shadow: 0 5px 15px rgba(255, 195, 0, 0.4); }
        .address-box { 
            background-color: var(--surface-bg-darker); 
            padding: 20px; border-radius: 16px; margin-bottom: 20px; 
            word-wrap: break-word; display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid var(--surface-border); cursor: pointer; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease; 
        }
        .address-box:hover { border-color: var(--primary-accent); }
        .address-box.copied { border-color: var(--success-color); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .address-box .address { flex: 1; margin-right: 15px; font-family: 'Courier New', monospace; word-break: break-all; font-size: 0.9em; }
        .copy-btn { background: none; border: none; color: var(--primary-accent); cursor: pointer; font-size: 1.5em; transition: color 0.3s ease, transform 0.3s ease; }
        .copy-btn:hover { color: var(--text-primary); transform: scale(1.1); }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: var(--surface-bg-darker); border: 1px solid var(--surface-border); color: var(--text-primary); width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s ease; z-index: 10; }
        .modal-close-btn:hover { background-color: rgba(255,255,255,0.1); transform: rotate(90deg); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--surface-bg); border-left: 6px solid var(--primary-accent); border-radius: 14px; padding: 20px 28px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); color: var(--text-primary); margin-bottom: 15px; opacity: 0; transform: translateX(100%); animation: toastIn 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; min-width: 320px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .toast.success { border-left-color: var(--success-color); }
        .toast.danger { border-left-color: var(--danger-color); }
        .toast.info { border-left-color: var(--secondary-accent); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Responsive adjustments */
        @media (max-width: 650px) {
            .plan-series-grid {
                grid-template-columns: 1fr; /* Stack plans on smaller screens */
            }
        }
        @media (max-width: 480px) {
            .content-panel { padding: 25px 20px; }
            .content-panel h3 { margin-bottom: 20px; padding-bottom: 10px; font-size: 1.4em; }
            
            /* Responsive Auth Overrides */
            .auth-form .content-panel { padding: 30px; border-radius: 5px 30px 5px 30px; }
            .auth-form h2 { font-size: 2.5em; text-align: center; margin-bottom: 30px;} 
            .auth-icon { font-size: 5em; margin-bottom: 20px; }
            /* Icon Swap Mobile Adjustment */
            .input-group input, .modal-content select { padding: 18px 55px 18px 20px; } /* Right padding for static icon */
            .input-group input:not([type="password"]) { padding-left: 20px; } /* No toggle, use default left padding */
            .input-group input[type="password"] { padding-left: 55px; padding-right: 55px; } /* Toggle left, Static right */
            .input-group i.fa-solid { left: auto; right: 20px; } /* Static icon right */
            .input-group .toggle-password { left: 20px; right: auto; } /* Toggle icon left */
            /* End Responsive Auth Overrides */

            .balance-display .amount { font-size: 3.5em; }
            .telegram-fab { width: 55px; height: 55px; right: 20px; bottom: 105px; font-size: 1.6em;}
            .profile-actions-grid { gap: 10px; }
            .action-card { padding: 18px; }
            .action-card i { font-size: 2.2em; }
            .action-card span { font-size: 0.9em; }
            .bottom-nav { width: calc(100% - 30px); height: 75px; border-radius: 20px; bottom: 15px; }
            .nav-btn { width: 60px; font-size: 0.7em; }
            .nav-btn i { font-size: 1.6em; }
            .staking-overview { gap: 15px; }

            /* Responsive Ranking Style */
            .ranking-item { padding: 12px; }
            .ranking-item .rank-num { font-size: 1.4em; width: 15%; } 
            .ranking-item .rank-num.top-3 { font-size: 1.8em; }
            .ranking-item .user-info { width: 40%; } 
            .ranking-item .net-worth { font-size: 1.1em; width: 45%; }
            .ranking-header-row { font-size: 0.8em; }
            
             /* Responsive Network Diagram */
            .network-diagram-container {
                overflow-x: scroll;
            }
            .network-tree {
                width: 600px; /* Ensure a minimum width for the chart to look good */
                margin: 0 auto;
            }
        }
         .fbr-certificate { 
            margin-top: 30px; 
            padding: 25px; 
            border: 3px solid var(--success-color); 
            border-radius: 20px; 
            background: var(--surface-bg-darker);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        .fbr-certificate h4 { 
            color: var(--success-color); 
            font-size: 1.5em; 
            margin-bottom: 10px;
        }
        .fbr-certificate p { 
            color: var(--text-secondary); 
            margin: 5px 0;
            font-size: 0.95em;
        }
        .fbr-certificate .seal {
            font-size: 3em;
            color: var(--warning-color);
            opacity: 0.5;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
        }

    </style>
</head>
<body class="landing-visible">
    <div id="particles-js"></div>
    <div id="background-effects">
        <div class="aurora-background"></div>
    </div>
    <div id="toast-container"></div>

    <!-- Preloader -->
    <div id="preloader"><div class="spinner"></div></div>
    
    <!-- [NEW] Landing Page Container -->
    <div id="landing-page-container">
        <header class="landing-header" id="landing-header">
            <!-- UPDATED Logo Structure -->
            <a href="#" class="landing-logo app-logo-link">
                <i class="fas fa-star logo-icon"></i>
                <span class="logo-name">Golden Star ‚≠ê</span>
            </a>
            <button class="btn enter-app-btn">Enter App</button>
        </header>
        <main class="landing-main">
            <section class="landing-hero">
                <h1>Unlock the Future of Digital Wealth</h1>
                <p>Welcome to Golden Star ‚≠ê, the next-generation ecosystem where your digital assets work for you. Engage in powerful earning plans, and build your network to maximize your USD earnings.</p>
                <button class="btn enter-app-btn">Get Started Now</button>
                <div class="scroll-down-indicator">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </section>
            
            <section class="landing-section">
                <div class="landing-section-header">
                    <h2>Perpetual Earning Engine</h2>
                    <p>Activate our powerful earning engine with a one-time investment and earn a continuous profit for a lifetime. Only Plan 20 Pro offers an unconditional 5% daily earning.</p>
                </div>
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-rocket"></i></div>
                        <h3>Lifetime Earnings</h3>
                        <p>Invest once, earn forever. Our plans are designed for perpetual growth and passive income.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                        <h3>Conditional Returns</h3>
                        <p>Most plans only allow earning from direct/indirect commissions. Purchase Plan 20 Pro for a guaranteed daily return.</p>
                        <div class="highlight">0% Daily Profit (Unless Pro)</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                        <h3>Pro-Earning Override</h3>
                        <p>Purchase the final plan (Plan 20 Pro) to instantly unlock a massive 5% daily earning without needing any referrals!</p>
                        <div class="highlight">Plan 20 Pro = 5% Daily Profit</div>
                    </div>
                </div>
            </section>

            <section class="landing-section">
                <div class="landing-section-header">
                    <h2>Powerful Blockchain Network</h2>
                    <p>Build your community and earn significant one-time commissions. Our multi-level block system rewards you for every new member you bring into the ecosystem.</p>
                </div>
                 <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-cubes"></i></div>
                        <h3>Direct Block Commission</h3>
                        <p>Earn a massive 50% commission on the first investment made by anyone you directly invite to the platform. (Requires your own plan purchase first).</p>
                        <div class="highlight">50% Direct Bonus</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-link"></i></div>
                        <h3>Deep Network Rewards</h3>
                        <p>Your earnings don't stop at your direct connections. Earn a 3% commission from indirect blocks up to 9 levels deep (one-time)!</p>
                        <div class="highlight">9 Blocks Deep | 3% Indirect</div>
                    </div>
                </div>
            </section>

            <section class="landing-section landing-cta">
                <div class="landing-section-header">
                    <h2>Ready to Join the Revolution?</h2>
                    <p>Your journey towards financial freedom starts here. Create your account in seconds and step into the future of digital wealth.</p>
                </div>
                <button class="btn enter-app-btn">Create My Account</button>
            </section>
        </main>
    </div>

    <!-- Authentication Container (Login/Register) - High Security Look Applied Here -->
    <div id="auth-container">
        <div id="login-page-container" class="auth-form">
            <!-- Login Photo/Icon in Center -->
            <div class="auth-icon"><i class="fas fa-gem"></i></div>
            <div class="content-panel">
                <h2>Access Login</h2>
                <form id="login-form">
                    <div class="input-group">
                        <input type="email" id="login-email" required placeholder="Email Address" autocomplete="email">
                        <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="login-password" required placeholder="Security Key" autocomplete="current-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Login Securely</span><div class="spinner-sm"></div></button>
                </form>
                <p class="auth-switch" style="margin-top: 15px; text-align: right; margin-bottom: 0;">
                    <a href="#" id="show-forgot-password-link">Forgot Password?</a>
                </p>
                <p class="auth-switch">No security profile? <a href="#" id="show-register-link">Create Account</a></p>
            </div>
        </div>
        <div id="register-page-container" class="auth-form" style="display: none;">
            <!-- Register Photo/Icon in Center -->
            <div class="auth-icon"><i class="fas fa-user-astronaut"></i></div>
            <div class="content-panel">
                <h2>Profile Registration</h2>
                <form id="register-form">
                    <div class="input-group">
                        <input type="text" id="register-username" required placeholder="Username" autocomplete="username">
                        <i class="fa-solid fa-user"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="email" id="register-email" required placeholder="Email" autocomplete="email">
                        <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="register-password" required placeholder="New Security Key" autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="register-repeat-password" required placeholder="Confirm Security Key" autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-key"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="register-ref-code" placeholder="Invitation Code (Optional)" autocomplete="off">
                        <i class="fa-solid fa-gift"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Create My Account</span><div class="spinner-sm"></div></button>
                </form>
                <p class="auth-switch">Already established profile? <a href="#" id="show-login-link">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container"> 
        <!-- New App Header -->
        <header class="app-header" id="app-header">
            <button class="menu-btn" id="menu-toggle-btn"><i class="fas fa-bars"></i></button>
            <!-- UPDATED Logo Structure -->
            <div class="logo-text app-logo-link">
                <i class="fas fa-star logo-icon"></i>
                <span class="logo-name">Golden Star ‚≠ê</span>
            </div>
            <div style="width: 45px; height: 45px;"></div> <!-- Spacer for balance/icons if needed -->
        </header>

        <!-- Sidebar Overlay (for closing) -->
        <div id="sidebar-overlay"></div>

        <!-- Sliding Sidebar (ADDED History Button) -->
        <aside id="app-sidebar">
            <div class="sidebar-user-info">
                <div class="profile-avatar"><i class="fas fa-user-astronaut"></i></div>
                <h2 id="sidebar-username-display">...</h2>
                <p id="sidebar-email-display" style="font-family: var(--font-family);">...</p>
                <div style="margin-top: 15px;">
                    <div class="stat-card" style="padding: 15px;">
                        <div class="label">User ID</div>
                        <div class="value" id="sidebar-uid-display" style="font-size: 1.1em; font-family: monospace;">...</div>
                    </div>
                </div>
            </div>
            <ul class="sidebar-action-list">
                <!-- NEW: History Button -->
                <li><button class="action-card history-btn" data-page-target="history-page"><i class="fas fa-history"></i><span>History</span></button></li>
                <li><button class="action-card nft-btn" data-page-target="nft-page"><i class="fas fa-gem"></i><span>NFTs</span></button></li>
                <li><button class="action-card sell-products-btn" data-page-target="sell-products-page"><i class="fas fa-store"></i><span>Sell Products</span></button></li>
                <li><button class="action-card free-mining-btn" data-page-target="free-mining-page"><i class="fas fa-bolt-lightning"></i><span>Free Plan</span></button></li>
                <li><button class="action-card about-btn" data-page-target="about-us-page"><i class="fas fa-info-circle"></i><span>About Us</span></button></li>
                <li><button class="action-card security-btn" data-page-target="security-page"><i class="fas fa-shield-halved"></i><span>Security</span></button></li>
                <li><button class="action-card logout-btn" id="sidebar-logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button></li>
            </ul>
        </aside>

        <!-- Draggable Floating Telegram Button -->
        <a href="https://t.me/automining009" target="_blank" class="telegram-fab" id="telegram-fab" title="Contact Support on Telegram">
            <i class="fab fa-telegram"></i>
        </a>

        <!-- Home Page (Dashboard/Plans) -->
        <main id="home-page" class="page active">
            <header class="header-welcome">
                <img src="https://iili.io/KPwy5uV.jpg" alt="Golden Star Logo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; box-shadow: 0 0 30px var(--primary-accent);">
                <h2 id="welcome-user">Welcome Back!</h2>
                <p>Your gateway to perpetual digital wealth.</p>
            </header>
            
            <!-- User Stats -->
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 30px;">
                <div class="stat-card"><div class="label">Your Wallet (USD)</div><div class="value" id="home-usd-balance">$0.00</div></div>
                <div class="stat-card"><div class="label">Your Wallet (PKR)</div><div class="value" id="home-pkr-balance">PKR 0</div></div>
                <div class="stat-card" style="grid-column: span 2;"><div class="label">Your Holdings Value (USD)</div><div class="value" id="home-holdings-value">$0.00</div></div>
            </div>

            <!-- MODIFIED: Your Active Plan Status Panel -->
            <div class="content-panel" id="active-plan-status" style="display: none;">
                <h3>Your Active Plan Status</h3>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card"><span class="label">Total Investment</span><span class="value" id="plan-investment-value">$0.00</span></div>
                    <div class="stat-card"><span class="label">Daily Profit Rate</span><span class="value profit" id="plan-profit-rate">$0.00</span></div>
                    <!-- REMOVED Ref Progress stat card as it's no longer relevant for Plan Earning -->
                </div>
                <!-- NEW Stat Card for Accumulated Profit (Moved out of grid for better display) -->
                 <div class="stat-card" style="grid-column: span 2; margin-top: 20px;">
                    <div class="label">Accumulated Profit</div>
                    <div class="value profit" id="plan-accumulated-profit" style="color: var(--success-color);">$0.000000</div>
                 </div>
                <div class="wallet-actions" style="margin-top: 25px;">
                    <button class="btn full-width" id="claim-plan-profit-btn" disabled style="flex-grow: 1;"><span class="btn-text"><i class="fas fa-hand-holding-dollar"></i> Claim Profit</span><div class="spinner-sm"></div></button>
                    <!-- NEW: Upgrade Plan Button -->
                    <button class="btn full-width" id="upgrade-plan-btn" style="background: linear-gradient(45deg, var(--background-secondary), var(--surface-bg)); color: var(--text-primary); border: 1px solid var(--primary-accent); flex-grow: 1;">
                        <span class="btn-text"><i class="fas fa-rocket"></i> Upgrade Plan</span>
                    </button>
                </div>
            </div>
            
            <!-- New Plans Section (MODIFIED GRID CLASS) - Always visible for purchase/upgrade -->
            <div class="content-panel" id="marketing-plans-panel">
                <h3>Perpetual Earning Plans</h3>
                <p class="info-text" style="margin-bottom: 25px;">Available: <b id="plans-page-pkr-balance">PKR 0</b> | <b id="plans-page-usd-balance">$0.00</b>. Only Plan 20 Pro offers 5% daily earnings.</p>
                <div id="marketing-plans-container" class="plan-series-grid">
                    <!-- Plans will be populated by JS -->
                </div>
            </div>

        </main>

        <!-- [NEW] Combined History Page -->
        <section id="history-page" class="page">
            <div class="page-header">
                <h3>Full Transaction History</h3>
            </div>
            <div class="content-panel">
                <h3>All System Transactions</h3>
                <p class="info-text" style="margin-bottom: 25px;">Review all deposits, withdrawals, plan, NFT, and referral transactions.</p>
                <!-- This will now hold ALL history data -->
                <ul id="history-list-combined" class="history-list">
                    <p class="info-text" id="no-transactions-msg">No transactions recorded yet.</p>
                </ul>
            </div>
        </section>


        <!-- [NEW] Ranking Page (Updated Style) -->
        <section id="ranking-page" class="page">
            <div class="page-header">
                <h3>Live User Ranking</h3>
            </div>
            <div class="content-panel">
                <h3>Top 50 Crypto Titans</h3>
                <p class="info-text" style="margin-bottom: 25px;">Ranked by Estimated Net Worth (Investment + Profit).</p>
                <div class="ranking-header-row" style="display: flex; justify-content: space-between; padding: 10px 15px; background-color: var(--background-secondary); border-radius: 12px; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">
                    <span style="width: 15%;">Rank</span>
                    <span style="width: 40%;">User</span>
                    <span style="width: 45%; text-align: right;">Net Worth (USD)</span>
                </div>
                <!-- Updated message for clear data state -->
                <ul id="ranking-list" class="history-list" style="max-height: 60vh; padding-right: 0;">
                    <p class="info-text" id="no-ranking-msg">No ranking data available yet. Start investing to see your rank!</p>
                </ul>
            </div>
            <div class="content-panel" id="user-rank-panel">
                <h3>Your Rank</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Your Net Worth</div>
                        <div class="value" id="my-net-worth-value">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <span class="label">Your Global Rank</span>
                        <span class="value" id="my-global-rank-value" style="color: var(--warning-color);">N/A</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Wallet Page (History Removed) -->
        <section id="wallet-page" class="page">
             <div class="page-header">
                <h3>My Wallet</h3>
            </div>
            <div class="content-panel">
                
                <div class="balance-display"><span class="amount" id="wallet-pkr-balance">PKR 0</span><span class="currency">Available PKR Balance</span></div>
                <div class="balance-on-hold" id="wallet-on-hold-balance">On Hold (USD): $0.00</div>
                <!-- MODIFIED BUTTONS STYLE/SIZE -->
                <div class="wallet-actions">
                    <button class="btn btn-buy" id="recharge-btn-modal" style="border-radius: 14px;"><i class="fas fa-plus-circle"></i>&nbsp; Recharge (PKR)</button>
                    <button class="btn btn-sell" id="withdraw-btn-modal" style="border-radius: 14px;"><i class="fas fa-paper-plane"></i>&nbsp; Withdraw (PKR)</button>
                </div>
            </div>
        </section>

        <!-- Profile Page (Simplified - actions are now in sidebar) -->
        <section id="profile-page" class="page">
            <div class="page-header">
                <h3>My Profile</h3>
            </div>
            <div class="content-panel">
                <div class="profile-header">
                    <div class="profile-avatar"><i class="fas fa-user-astronaut"></i></div>
                    <h2 id="profile-username-display">...</h2>
                    <p id="profile-email-display">...</p>
                </div>
                <div style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="label">User ID</div>
                        <div class="value" id="profile-uid-display" style="font-size: 1.2em; font-family: monospace;">...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invite Page (MODIFIED: History Removed) -->
        <section id="invite-page" class="page">
            <div class="page-header">
                <h3>Your Network</h3>
            </div>
            <div class="content-panel">
                <div class="bonus-display">
                    <div class="label">Unclaimed Block Income (USD)</div>
                    <div class="amount" id="unclaimed-bonus-amount">$0.00</div>
                </div>
                <button class="btn btn-claim full-width" id="collect-bonus-btn" disabled><span class="btn-text">Collect Income</span><div class="spinner-sm"></div></button>
            </div>
            <div class="content-panel invite-box">
                <div class="icon"><i class="fas fa-cubes"></i></div>
                <p>Share your link. You earn a one-time <b>50%</b> commission from your direct block's first investment and a one-time <b>3%</b> from indirect blocks up to 9 levels deep! <b>(A plan purchase is required to activate bonus earning)</b></p>
                <div class="invite-code" id="invite-link-display">Generating...</div>
                <button class="btn full-width" id="copy-invite-link-btn"><span class="btn-text"><i class="fas fa-copy"></i>&nbsp; Copy My Link</span></button>
            </div>
            
            <!-- [START DYNAMIC BLOCK] Network Diagram -->
            <div class="content-panel">
                <h3>Your Block Network</h3>
                <p class="info-text" style="margin-bottom: 20px; text-align: center;">Click on any block level card below to view all the members in that block.</p>
                <div id="dynamic-network-map" class="dynamic-network-container">
                    <!-- Root Node (You) -->
                    <div class="network-root-node">
                        <i class="fas fa-crown"></i>
                        YOU
                    </div>
                    <!-- Dynamic network levels will be populated here by JS -->
                    <div id="network-levels-container">
                        <p class="info-text">Loading network data...</p>
                    </div>
                </div>
            </div>
            <!-- [END DYNAMIC BLOCK] -->
        </section>
        
        <!-- Security Page (Removed back button) -->
        <section id="security-page" class="page">
            <div class="page-header">
                <h3>Security Center</h3>
            </div>
            <div class="content-panel">
                <h3>Change Password</h3>
                <form id="change-password-form">
                    <div class="input-group">
                        <input type="password" id="current-password" placeholder="Current Security Key" required autocomplete="current-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-key"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="password" id="new-password" placeholder="New Security Key" required autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Change Password</span><div class="spinner-sm"></div></button>
                </form>
            </div>
        </section>

        <!-- Free Mining Page (Removed back button) -->
        <section id="free-mining-page" class="page">
             <div class="page-header">
                <h3>Gain Free Earning Plan</h3>
            </div>
             <div class="content-panel invite-box">
                <div class="icon" style="color: var(--success-color); text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);"><i class="fas fa-gifts"></i></div>
                <h3>Unlock a Permanent Free Earning Plan!</h3>
                <p>As a special reward for our community builders, you can earn a free lifetime plan.</p>
                <p><b>Requirement:</b> Invite 2 new users. After each of them has made their first deposit and purchased an earning plan, you become eligible.</p>
                <div class="stat-card" style="margin: 25px 0;">
                    <div class="label">Your Progress</div>
                    <div class="value" id="free-mining-progress">0 / 2</div>
                    <p class="info-text" style="margin-top: 10px;">Active Referrals</p>
                </div>
                <p>Once your progress bar shows <b>2 / 2</b>, please contact our customer service via the Telegram button to claim your reward. Our team will verify your referrals and activate your free plan.</p>
            </div>
        </section>
        
        <!-- About Us Page (Removed back button) -->
        <section id="about-us-page" class="page">
            <div class="page-header">
                <h3>About Digital Wealth Platform</h3>
            </div>
            <div class="content-panel">
                <h3>Our Vision: The Future of Digital Networks</h3>
                <p class="info-text" style="text-align: left; margin-bottom: 20px;">Our platform was founded on the principle of bridging the gap between the stability of traditional finance and the limitless potential of digital asset management. Our mission is to create an accessible, secure, and profitable ecosystem for everyone, from novices to seasoned investors.</p>
                <p class="info-text" style="text-align: left;">We believe in empowering our community through innovative solutions like our Lifetime Earning Plans and NFT protocols. By rewarding users for their participation and loyalty, we are building a robust and self-sustaining digital economy. Join us as we redefine the future of wealth management.</p>

                <div class="fbr-certificate">
                    <h4>Federal Board of Revenue</h4>
                    <p><strong>Certificate of Registration</strong></p>
                    <p>This is to certify that</p>
                    <p style="font-weight: bold; font-size: 1.3em;">DIGITAL ASSET MANAGEMENT LTD.</p>
                    <p>is registered with the Federal Board of Revenue, under the Companies Act, 2017.</p>
                    <p><strong>Registration Number:</strong> 00198756-2024</p>
                    <p><strong>Date of Incorporation:</strong> JAN 01, 2024</p>
                    <div class="seal"><i class="fas fa-stamp"></i></div>
                    <p style="font-size: 0.8em; margin-top: 10px;">Official Seal - Government of Pakistan</p>
                </div>
            </div>
        </section>

        <!-- [NEW] NFT Page (Removed back button) -->
        <section id="nft-page" class="page">
            <div class="page-header">
                <h3>NFT Investment Collection</h3>
            </div>
            
            <!-- NEW: NFT Requirement Panel -->
            <div class="content-panel" id="nft-requirement-panel">
                <!-- Content injected by JS: locked/unlocked status, progress bar -->
                <p class="info-text">Loading NFT Requirement Status...</p>
            </div>
            <!-- END NEW: NFT Requirement Panel -->

            <div class="content-panel">
                <p class="info-text" style="margin-bottom: 25px;">Purchase an NFT to earn a 3% daily return on your investment, up to a total of 300%. Your available balance is <b id="nft-page-usd-balance">$0.00</b>.</p>
                <button class="btn full-width" id="view-my-nfts-btn"><span class="btn-text">View My NFTs (Achieved)</span></button>
            </div>
            <div class="nft-grid" id="nft-grid-container">
                <!-- Bronze Card -->
                <div class="nft-card" id="nft-bronze">
                    <div class="nft-visual"><i class="fas fa-shield-alt"></i></div>
                    <h4>Bronze Miner NFT</h4>
                    <p class="price-range">$10 - $30</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (10-30)" class="nft-buy-amount" min="10" max="30">
                        <i class="fa-solid fa-dollar-sign"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="bronze" data-min="10" data-max="30" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
                <!-- Silver Card -->
                <div class="nft-card" id="nft-silver">
                    <div class="nft-visual"><i class="fas fa-star-of-david"></i></div>
                    <h4>Silver Prospector NFT</h4>
                    <p class="price-range">$31 - $50</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (31-50)" class="nft-buy-amount" min="31" max="50">
                        <i class="fa-solid fa-dollar-sign"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="silver" data-min="31" data-max="50" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
                <!-- Gold Card -->
                <div class="nft-card" id="nft-gold">
                    <div class="nft-visual"><i class="fas fa-crown"></i></div>
                    <h4>Gold Titan NFT</h4>
                    <p class="price-range">$51 - $100</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (51-100)" class="nft-buy-amount" min="51" max="100">
                        <i class="fa-solid fa-dollar-sign"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="gold" data-min="51" data-max="100" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- [NEW] My NFTs Page (History Removed) -->
        <section id="my-nfts-page" class="page">
            <div class="page-header">
                <!-- Keep internal back button to NFT Page -->
                <button class="back-btn" data-target="nft-page"><i class="fas fa-arrow-left"></i></button>
                <h3>My NFT Portfolio</h3>
            </div>
            <div id="my-nfts-list">
                <!-- User's purchased NFTs will be populated here by JS -->
            </div>
            <div class="content-panel" id="no-nfts-msg" style="display: none;">
                <p class="info-text">You have not purchased any NFTs yet. Visit the NFT Collection to get started.</p>
            </div>
        </section>

        <!-- [NEW] Sell Products Page (Removed back button) -->
        <section id="sell-products-page" class="page">
            <div class="page-header">
                <h3>Sell Our Products</h3>
            </div>
            <div class="content-panel invite-box">
                 <div class="icon" style="color: var(--primary-accent);"><i class="fas fa-tools"></i></div>
                <h2>Coming Soon!</h2>
                <p>An exciting new feature is under development. Soon, you'll be able to sell our products and earn generous commissions. Stay tuned for updates!</p>
            </div>
        </section>

        <!-- Bottom Navigation Bar (Updated names and target pages) -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="invite-page"><i class="fas fa-link"></i><span>Network</span></button>
            <button class="nav-btn" data-page="ranking-page"><i class="fas fa-chart-bar"></i><span>Rank</span></button>
            <button class="nav-btn" data-page="wallet-page"><i class="fas fa-wallet"></i><span>Assets</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user-circle"></i><span>Me</span></button>
        </nav>
    </div>

    <!-- Modals (Kept as is) -->
    
    <!-- MODAL FOR FORGOT PASSWORD (NEW) -->
    <div id="forgot-password-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="forgot-password-modal">√ó</button>
            <h3>Reset Your Password</h3>
            <p class="info-text">Enter your account email address. We will send you a link to reset your password.</p>
            <form id="forgot-password-form">
                <div class="input-group">
                    <input type="email" id="reset-email" required placeholder="Registered Email Address" autocomplete="email">
                    <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                </div>
                <button type="submit" class="btn full-width" id="submit-reset-email-btn" style="border-radius: 14px;">
                    <span class="btn-text">Send Reset Link</span><div class="spinner-sm"></div>
                </button>
            </form>
        </div>
    </div>
    <!-- END MODAL FOR FORGOT PASSWORD -->


    <!-- MODAL FOR PLAN PURCHASE CONFIRMATION -->
    <div id="plan-purchase-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="plan-purchase-modal">√ó</button>
            <h3 id="plan-modal-title">Confirm Plan Purchase</h3>
            <p class="info-text">You are about to purchase the <b id="plan-modal-name">...</b> plan.</p>
            <p class="info-text" style="margin-bottom: 20px;">Available: <b id="plan-modal-pkr-balance">PKR 0</b> | <b id="plan-modal-usd-balance">$0.00</b></p>
            <form id="plan-purchase-form">
                <div class="input-group">
                    <input type="text" id="plan-cost-display" readonly>
                    <i class="fa-solid fa-money-bill-wave"></i> <!-- Static Icon (Right) -->
                </div>
                <input type="hidden" id="plan-purchase-usd-cost">
                <input type="hidden" id="plan-purchase-plan-id">
                <button type="submit" class="btn full-width" id="confirm-plan-purchase-btn" style="border-radius: 14px;">
                    <span class="btn-text">Confirm & Purchase</span><div class="spinner-sm"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- MODIFIED RECHARGE MODAL FOR PKR - ONLY EASYPAISA -->
    <div id="recharge-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="recharge-modal">√ó</button>
            <h3>Recharge PKR (Easypaisa)</h3>
            <p class="info-text">Send money to the Easypaisa account below, or scan the QR code:</p>
            
            <!-- Easypaisa Details - Now the only option -->
            <div id="recharge-easypaisa" class="recharge-details">
                <div class="address-box" style="margin-top: 15px;">
                    <span class="address" id="easypaisa-account-number" style="font-size: 1.1em; font-weight: 600;">03199242314</span>
                    <button class="copy-btn" tabindex="-1" data-copy-target-id="easypaisa-account-number"><i class="far fa-copy"></i></button>
                </div>
                <p class="info-text" style="margin-bottom: 15px;">**Account Holder: MUHAMMAD HASEEB**</p>

                <div style="text-align: center; margin-bottom: 25px;">
                    <!-- QR code updated to the new URL -->
                    <img src="https://iili.io/Ki1gPyJ.jpg" 
                         alt="Easypaisa QR Code for MUHAMMAD HASEEB" 
                         style="width: 200px; height: auto; border-radius: 10px; border: 3px solid var(--primary-accent); max-width: 80%;">
                    <p class="info-text" style="font-size: 0.8em; margin-top: 5px;">(QR code for MUHAMMAD HASEEB's easypaisa account)</p>
                </div>
            </div>

            <p class="info-text" style="margin-top: 25px;">After sending, enter the transaction details below.</p>
            <form id="recharge-form">
                <div class="input-group" style="margin-top: 15px;">
                    <input type="number" id="recharge-amount" placeholder="Amount Sent (PKR)" required min="100" step="1">
                    <i class="fa-solid fa-rupiah-sign"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <input type="text" id="sender-account-number" placeholder="Your Sender Account Number (11 digits)" required pattern="\d{11}" maxlength="11">
                    <i class="fa-solid fa-phone"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <input type="text" id="transaction-id" placeholder="Transaction ID (TxID/TID - MUST BE CORRECT)" required>
                    <i class="fa-solid fa-receipt"></i> <!-- Static Icon (Right) -->
                </div>
                <button id="submit-recharge-btn" type="submit" class="btn full-width" style="border-radius: 14px;">
                    <span class="btn-text">Submit for Review</span><div class="spinner-sm"></div>
                </button>
            </form>
        </div>
    </div>
    <!-- END MODIFIED RECHARGE MODAL -->
    
    <!-- MODIFIED WITHDRAWAL MODAL FOR PKR -->
    <div id="withdrawal-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="withdrawal-modal">√ó</button>
            <h3>Withdraw PKR</h3>
            <form id="withdrawal-form">
                <div class="input-group">
                    <input type="number" id="withdraw-amount" placeholder="Amount (PKR)" required min="100" step="1">
                    <i class="fa-solid fa-rupiah-sign"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <select id="withdraw-network" required>
                        <option value="">-- Select Method --</option>
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="withdraw-account-number" placeholder="11-Digit Account Number" required pattern="\d{11}" maxlength="11">
                    <i class="fa-solid fa-address-card"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <input type="text" id="withdraw-account-holder-name" placeholder="Account Holder Name" required>
                    <i class="fa-solid fa-user"></i> <!-- Static Icon (Right) -->
                </div>
                <button id="submit-withdrawal-btn" type="submit" class="btn full-width" style="border-radius: 14px;">
                    <span class="btn-text">Request Withdrawal</span><div class="spinner-sm"></div>
                </button>
            </form>
            <p class="info-text">A 5% service fee applies to the USD equivalent. Funds will be processed within 24 hours.</p>
        </div>
    </div>
    <!-- END MODIFIED WITHDRAWAL MODAL -->
    
    <!-- Blockchain Block List Modal (Used to display members when a level is clicked) -->
    <div id="block-list-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="block-list-modal">√ó</button>
            <h3 id="block-list-modal-title">Block Referrals</h3>
            <ul id="block-list-modal-body" class="history-list" style="padding-right: 0;">
                <!-- JS will populate this with modal-member-item -->
                <p class="info-text">No users found at this block level.</p>
            </ul>
        </div>
    </div>

    <!-- Firebase & Particle.js -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- [1] CONFIG & INITIALIZATION ---
            config: {
                firebase: {
                    // NOTE: The Firebase configuration keys below are updated as requested.
                    apiKey: "AIzaSyBrLjKm-OXg_H0YkdayyMXVBa9vzpvBjks", // UPDATED
                    authDomain: "block-chain-golden-star.firebaseapp.com", // Updated based on DB URL
                    databaseURL: "https://block-chain-golden-star-default-rtdb.asia-southeast1.firebasedatabase.app/", // UPDATED
                    projectId: "block-chain-golden-star", // Updated based on DB URL
                    storageBucket: "block-chain-golden-star.appspot.com", // Updated based on DB URL
                    messagingSenderId: "123456789012", // Generic placeholder
                    appId: "1:123456789012:web:abcdefg123456789" // Generic placeholder
                },
                PKR_TO_USD_RATE: 280, // Conversion rate for display purposes (1 USD = 280 PKR)
                WITHDRAWAL_FEE_PERCENT: 0.05,
                PRELOADER_TIMEOUT: 8000,
                
                // --- MODIFIED PLAN CONFIG ---
                PLAN_DAILY_RATE_PERCENT: 0.03, // 3% - No longer used for main daily earning
                PLAN_DAILY_RATE_PRO_PERCENT: 0.05, // 5% - Only for Plan 20 Pro
                // REQUIRED_ACTIVE_REFERRALS_FOR_3_PERCENT: 2, // NO LONGER NEEDED
                PLAN_20_ID: 20, 
                MINIMUM_PROFIT_CLAIM_USD: 0.000001,
                // --- END MODIFIED PLAN CONFIG ---
                
                // Referral config (kept to support 10 levels: 1 Direct + 9 Indirect)
                REFERRAL_LEVELS: 9, // This is the depth of indirect bonuses (L2-L10)
                REFERRAL_DIRECT_BONUS_PERCENT: 0.50,
                REFERRAL_INDIRECT_BONUS_PERCENT: 0.03,
                
                // FREE PLAN GATE MODIFIED (kept as is)
                FREE_PLAN_REQUIRED_REFERRALS: 2, 
                
                MINING_GATE_INVESTMENT_USD: 5, 
                MINING_GATE_REQUIRED_REFERRALS: 3, 
                RANKING_LIMIT: 50,
                
                // NFT Config (Kept as is for compatibility)
                NFT_DAILY_RATE_PERCENT: 0.03, 
                NFT_TOTAL_RETURN_PERCENT: 3.00, 
                NFT_DURATION_DAYS: 100,
                // NEW: NFT Requirement
                NFT_REQUIRED_ACTIVE_REFERRALS: 10, 
                
                // --- MODIFIED MARKETING_PLANS CONFIG ---
                MARKETING_PLANS: (() => {
                    const plans = [];
                    let pkrCost = 630;
                    for (let i = 1; i <= 20; i++) {
                        const usdCost = pkrCost / 280; 
                        const isPlan20 = i === 20;
                        plans.push({
                            id: i,
                            name: i === 1 ? "Plan 1 +series" : `Plan ${i} Pro`, 
                            pkrCost: pkrCost,
                            usdCost: parseFloat(usdCost.toFixed(2)),
                            duration: "Lifetime",
                            // Plan 20 is 5%, all others are 0% for non-working income
                            dailyRate: isPlan20 ? 0.05 : 0.00, 
                        });
                        pkrCost += 630; 
                    }
                    return plans;
                })(),
                // --- END MODIFIED MARKETING_PLANS CONFIG ---
                
                // PKR Deposit Info
                EASYPAISA_ACCOUNT_NUMBER: '03199242314',
                EASYPAISA_ACCOUNT_HOLDER: 'MUHAMMAD HASEEB', 
                EASYPAISA_QR_URL: 'https://iili.io/Ki1gPyJ.jpg', 
            },

            // --- [2] STATE MANAGEMENT ---
            state: {
                currentUser: null,
                userData: null,
                allUsersData: [], 
                userRef: null,
                txRef: null,
                preloaderTimeoutId: null,
                planProfitInterval: null, 
                nftIntervals: {},
                ui: {},
            },

            async init() {
                this.cacheDOMElements();
                this.initFirebase();
                this.initDraggableFAB();
                this.listenToAllUserData();
                this.initParticles();
                this.bindEventListeners();
                this.initLandingPageAnimations();
                this.handleAuth();
                this.state.preloaderTimeoutId = setTimeout(() => this.hidePreloader(), this.config.PRELOADER_TIMEOUT);
                this.checkForRefCode();
            },

            initFirebase() {
                try {
                    const firebaseConfig = this.config.firebase;
                    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                    this.auth = firebase.auth();
                    this.db = firebase.database();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showToast('Application failed to load.', 'danger');
                }
            },
            
            listenToAllUserData() {
                this.db.ref('users').on('value', (snapshot) => {
                    const allUsers = snapshot.val();
                    if (allUsers) {
                        const rankedUsers = Object.entries(allUsers).map(([uid, data]) => ({
                            ...data,
                            uid: uid,
                            netWorth: this.calculateUserNetWorth(data)
                        }));

                        rankedUsers.sort((a, b) => b.netWorth - a.netWorth);
                        this.state.allUsersData = rankedUsers;
                        if (this.state.currentUser) this.updateRankingUI(); 
                    }
                }, (error) => {
                    console.error("Firebase all user data error for ranking:", error);
                });
            },

            initParticles() {
                if (typeof particlesJS !== 'undefined') {
                    particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":"#FFC300"},"shape":{"type":"circle"},"opacity":{"value":0.6,"random":true,"anim":{"enable":true,"speed":1,"opacity_min":0.1}},"size":{"value":2,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#B8860B","opacity":0.15,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out"}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"}},"modes":{"grab":{"distance":140,"line_linked":{"opacity":0.2}},"push":{"particles_nb":4}}},"retina_detect":true});
                }
            },
            
            // --- [3] UI / DOM MANIPULATION ---
            cacheDOMElements() {
                this.state.ui = {
                    body: document.body,
                    landingPageContainer: document.getElementById('landing-page-container'),
                    preloader: document.getElementById('preloader'), authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'), toastContainer: document.getElementById('toast-container'), telegramFab: document.getElementById('telegram-fab'),
                    loginPage: document.getElementById('login-page-container'), registerPage: document.getElementById('register-page-container'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), registerRefCodeInput: document.getElementById('register-ref-code'),
                    
                    // New App Header & Sidebar
                    appHeader: document.getElementById('app-header'),
                    menuToggleBtn: document.getElementById('menu-toggle-btn'),
                    appSidebar: document.getElementById('app-sidebar'),
                    sidebarOverlay: document.getElementById('sidebar-overlay'),
                    sidebarUsernameDisplay: document.getElementById('sidebar-username-display'),
                    sidebarEmailDisplay: document.getElementById('sidebar-email-display'),
                    sidebarUidDisplay: document.getElementById('sidebar-uid-display'),
                    sidebarLogoutBtn: document.getElementById('sidebar-logout-btn'),

                    welcomeUser: document.getElementById('welcome-user'), 
                    homeUsdBalance: document.getElementById('home-usd-balance'), 
                    homePkrBalance: document.getElementById('home-pkr-balance'), 
                    homeHoldingsValue: document.getElementById('home-holdings-value'),
                    
                    // New Plan UI Elements
                    plansPageUsdBalance: document.getElementById('plans-page-usd-balance'),
                    plansPagePkrBalance: document.getElementById('plans-page-pkr-balance'), 
                    marketingPlansContainer: document.getElementById('marketing-plans-container'),
                    marketingPlansPanel: document.getElementById('marketing-plans-panel'),
                    activePlanStatus: document.getElementById('active-plan-status'),
                    planInvestmentValue: document.getElementById('plan-investment-value'),
                    planProfitRate: document.getElementById('plan-profit-rate'),
                    // planRefProgress: document.getElementById('plan-ref-progress'), // REMOVED
                    planAccumulatedProfit: document.getElementById('plan-accumulated-profit'),
                    claimPlanProfitBtn: document.getElementById('claim-plan-profit-btn'),
                    upgradePlanBtn: document.getElementById('upgrade-plan-btn'), 
                    planPurchaseModal: document.getElementById('plan-purchase-modal'),
                    planModalTitle: document.getElementById('plan-modal-title'),
                    planModalName: document.getElementById('plan-modal-name'),
                    planModalUsdBalance: document.getElementById('plan-modal-usd-balance'),
                    planModalPkrBalance: document.getElementById('plan-modal-pkr-balance'), 
                    planCostDisplay: document.getElementById('plan-cost-display'),
                    planPurchaseUsdCost: document.getElementById('plan-purchase-usd-cost'),
                    planPurchasePlanId: document.getElementById('plan-purchase-plan-id'), 
                    planPurchaseForm: document.getElementById('plan-purchase-form'),
                    
                    walletUsdBalance: document.getElementById('wallet-usd-balance'), 
                    walletPkrBalance: document.getElementById('wallet-pkr-balance'), 
                    walletOnHoldBalance: document.getElementById('wallet-on-hold-balance'), 
                    rechargeForm: document.getElementById('recharge-form'), 
                    withdrawalForm: document.getElementById('withdrawal-form'),
                    
                    // Ranking UI Elements
                    rankingList: document.getElementById('ranking-list'),
                    myNetWorthValue: document.getElementById('my-net-worth-value'),
                    myGlobalRankValue: document.getElementById('my-global-rank-value'),
                    
                    profileUsernameDisplay: document.getElementById('profile-username-display'), profileEmailDisplay: document.getElementById('profile-email-display'), profileUidDisplay: document.getElementById('profile-uid-display'),
                    changePasswordForm: document.getElementById('change-password-form'),
                    inviteLinkDisplay: document.getElementById('invite-link-display'),
                    
                    unclaimedBonusAmount: document.getElementById('unclaimed-bonus-amount'), collectBonusBtn: document.getElementById('collect-bonus-btn'), 
                    
                    // --- Network UI Elements ---
                    networkLevelsContainer: document.getElementById('network-levels-container'), 
                    blockListModal: document.getElementById('block-list-modal'), 
                    blockListModalTitle: document.getElementById('block-list-modal-title'), 
                    blockListModalBody: document.getElementById('block-list-modal-body'),
                    // --- End Network UI Elements ---

                    freeMiningProgress: document.getElementById('free-mining-progress'),
                    
                    nftPageUsdBalance: document.getElementById('nft-page-usd-balance'),
                    nftGridContainer: document.getElementById('nft-grid-container'),
                    myNftsListPage: document.getElementById('my-nfts-page'),
                    myNftsList: document.getElementById('my-nfts-list'),
                    noNftsMsg: document.getElementById('no-nfts-msg'),
                    viewMyNftsBtn: document.getElementById('view-my-nfts-btn'),
                    
                    // NEW: NFT Requirement Panel
                    nftRequirementPanel: document.getElementById('nft-requirement-panel'),

                    // Recharge Modal specific
                    rechargeEasypaisa: document.getElementById('recharge-easypaisa'),
                    
                    // History List Elements (MODIFIED for combined list)
                    historyLists: {
                        combined: { list: document.getElementById('history-list-combined'), msg: document.getElementById('no-transactions-msg') },
                    }
                };
                
                this.updatePlansUI(); 
            },
            
            showPage(pageId) { 
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
                document.getElementById(pageId)?.classList.add('active'); 
                
                // Close sidebar when navigating to a page
                this.closeSidebar(); 
                
                // Update bottom nav active state
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const isMainTab = ['home-page', 'invite-page', 'ranking-page', 'wallet-page', 'profile-page'].includes(pageId);
                    b.classList.toggle('active', isMainTab && b.dataset.page === pageId);
                });
                
                window.scrollTo(0, 0); 
            },
            showModal(modalId) { document.getElementById(modalId)?.classList.add('active'); },
            hideModal(modalId) { document.getElementById(modalId)?.classList.remove('active'); },
            showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; this.state.ui.toastContainer.appendChild(toast); setTimeout(() => toast.remove(), 4000); },
            hidePreloader() { if (this.state.preloaderTimeoutId) clearTimeout(this.state.preloaderTimeoutId); this.state.ui.preloader.classList.add('hidden'); },
            setButtonLoading(btn, isLoading) { if (btn) { btn.classList.toggle('loading', isLoading); btn.disabled = isLoading; } },
            
            openSidebar() {
                this.state.ui.appSidebar.classList.add('active');
                this.state.ui.sidebarOverlay.style.display = 'block';
            },

            closeSidebar() {
                this.state.ui.appSidebar.classList.remove('active');
                this.state.ui.sidebarOverlay.style.display = 'none';
            },

            updateUI() {
                if (!this.state.userData) return;
                const { username, email, uid, referralCode, usd_balance = 0, balance_on_hold = 0 } = this.state.userData;
                const pkr_balance = usd_balance * this.config.PKR_TO_USD_RATE;

                const formatCurrencyUSD = (num) => `$${Number(num || 0).toFixed(2)}`;
                const formatCurrencyPKR = (num) => `PKR ${Math.round(Number(num || 0)).toLocaleString()}`;
                
                // Common UI elements
                this.state.ui.welcomeUser.textContent = `Welcome, ${username || email.split('@')[0]}`;
                
                // Balances
                const holdingsValue = this.calculateUserHoldings(this.state.userData);
                
                this.state.ui.homeUsdBalance.textContent = formatCurrencyUSD(usd_balance);
                this.state.ui.homePkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                
                this.state.ui.walletPkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                this.state.ui.walletOnHoldBalance.textContent = `On Hold (USD): ${formatCurrencyUSD(balance_on_hold)}`;
                this.state.ui.homeHoldingsValue.innerText = formatCurrencyUSD(holdingsValue);
                
                this.state.ui.nftPageUsdBalance.textContent = formatCurrencyUSD(usd_balance);
                
                this.state.ui.plansPageUsdBalance.textContent = formatCurrencyUSD(usd_balance);
                this.state.ui.plansPagePkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                
                // Profile Page & Sidebar
                this.state.ui.profileUsernameDisplay.textContent = username || 'Not Set';
                this.state.ui.profileEmailDisplay.textContent = email;
                this.state.ui.profileUidDisplay.textContent = uid;

                this.state.ui.sidebarUsernameDisplay.textContent = username || 'Not Set';
                this.state.ui.sidebarEmailDisplay.textContent = email;
                this.state.ui.sidebarUidDisplay.textContent = uid;
                
                // Invite Page
                this.state.ui.inviteLinkDisplay.innerText = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
                
                // Update component-specific UIs
                this.updatePlanUI(); 
                this.updateNetworkUI(); 
                this.updateFreeMiningUI();
                this.updateNFTRequirementUI(); 
                this.updateMyNftsUI();
                this.updateRankingUI();
            },

            calculateUserHoldings(userData) {
                const planInvestment = userData.plans?.totalInvestmentUSD || 0;
                const planProfit = userData.plans?.totalProfitGeneratedUSD || 0;
                let nftValue = 0;
                if (userData.nfts) {
                    Object.values(userData.nfts).forEach(nft => {
                        nftValue += (nft.investment || 0) + (nft.totalProfitClaimed || 0); 
                    });
                }
                // Holdings = Liquid USD + Plan Investment + Plan Profit + NFT Value
                return (userData.usd_balance || 0) + planInvestment + planProfit + nftValue;
            },

            // MODIFIED: Consolidate all history into one list + add status styling
            updateAllHistories(transactions) {
                const txArray = transactions ? Object.values(transactions).sort((a, b) => b.timestamp - a.timestamp) : [];

                // All transactions go to the combined list
                this.populateHistoryList(this.state.ui.historyLists.combined, txArray);
            },

            populateHistoryList(listConfig, transactions) {
                if (!listConfig || !listConfig.list || !listConfig.msg) return;
                const { list, msg } = listConfig;

                list.innerHTML = '';
                if (transactions.length === 0) {
                    list.appendChild(msg);
                    return;
                }
                
                // Hide the placeholder message if it was mistakenly appended
                if (msg.parentElement === list) {
                    msg.remove();
                }

                transactions.forEach(tx => {
                    const item = document.createElement('li');
                    const status = tx.details?.status?.toLowerCase(); // 'pending', 'approved', 'rejected'
                    
                    let statusClass = '';
                    if (status === 'pending') statusClass = 'pending';
                    else if (status === 'approved') statusClass = 'approved';
                    else if (status === 'rejected') statusClass = 'rejected';
                    
                    item.className = `transaction-item ${tx.type.toLowerCase().replace('mining', 'plan')} ${statusClass}`;
                    
                    // Updated icons for transaction types
                    const icons = { deposit: 'fa-arrow-down', withdrawal: 'fa-paper-plane', bonus: 'fa-gift', plan_profit: 'fa-arrow-up-right-dots', plan_invest: 'fa-sack-dollar', invite_bonus: 'fa-users', nft_purchase: 'fa-gem', nft_profit: 'fa-hand-holding-usd' };
                    
                    const isFiatTx = tx.type === 'deposit' && (tx.details?.network === 'easypaisa' || tx.details?.network === 'jazzcash') || (tx.type === 'withdrawal' && (tx.details?.network === 'easypaisa' || tx.details?.network === 'jazzcash'));
                    
                    let amountDisplay;
                    let typeText = tx.type.replace(/_/g, ' ').replace('plan', 'plan').replace('invest', 'purchase');
                    
                    if (isFiatTx && tx.details?.pkrAmount) {
                        const sign = ['withdrawal', 'nft_purchase', 'plan_invest'].includes(tx.type) ? '-' : '+';
                        amountDisplay = `${sign}PKR ${Math.round(tx.details.pkrAmount).toLocaleString()}`;
                        typeText = `${tx.details.network} ${typeText}`;
                    } else {
                        const sign = ['withdrawal', 'plan_invest', 'nft_purchase'].includes(tx.type) ? '-' : '+';
                        amountDisplay = `${sign}$${Number(tx.amount).toFixed(4)}`;
                    }

                    // Status display text
                    let statusDisplay = '';
                    if (status === 'pending') statusDisplay = `<span style="color: var(--warning-color); font-weight: normal;">(Pending)</span>`;
                    else if (status === 'rejected') statusDisplay = `<span style="color: var(--danger-color); font-weight: normal;">(Rejected)</span>`;
                    else if (status === 'approved') statusDisplay = `<span style="color: var(--success-color); font-weight: normal;">(Approved)</span>`;

                    const typeDisplay = (tx.details?.reason || typeText) + statusDisplay;

                    item.innerHTML = `<div class="icon"><i class="fas ${icons[tx.type.toLowerCase()] || 'fa-exchange-alt'}"></i></div><div class="details"><div class="type">${typeDisplay}</div><div class="date">${new Date(tx.timestamp).toLocaleString()}</div></div><div class="amount">${amountDisplay}</div>`;
                    list.appendChild(item);
                });
            },
            
            // --- [4] EVENT LISTENERS & HANDLERS ---
            bindEventListeners() {
                // Landing Page
                document.querySelectorAll('.enter-app-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.state.ui.landingPageContainer.style.display = 'none';
                        this.state.ui.body.classList.remove('landing-visible');
                        this.state.ui.authContainer.classList.add('active');
                    });
                });
                window.addEventListener('scroll', () => {
                    const header = document.getElementById('landing-header');
                    if (header) { 
                        if (window.scrollY > 50) {
                            header.classList.add('scrolled');
                        } else {
                            header.classList.remove('scrolled');
                        }
                    }
                });

                // Auth
                document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); this.state.ui.loginPage.style.display = 'none'; this.state.ui.registerPage.style.display = 'block'; });
                document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); this.state.ui.registerPage.style.display = 'none'; this.state.ui.loginPage.style.display = 'block'; });
                
                // NEW: Forgot Password Link
                document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    this.showModal('forgot-password-modal'); 
                });
                document.getElementById('forgot-password-form').addEventListener('submit', (e) => this.handleForgotPassword(e));

                this.state.ui.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.state.ui.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                
                // --- MODIFIED Password Toggle: Only react to icon click ---
                document.querySelectorAll('.toggle-password').forEach(toggle => { 
                    // Ensures the click only works on the icon itself, not the input
                    toggle.addEventListener('click', (e) => { 
                        const icon = e.target; 
                        // Find the input element sibling within the same input-group
                        const input = icon.closest('.input-group')?.querySelector('input[type="password"], input[type="text"]'); 
                        
                        if(input) { 
                            if (input.type === 'password') {
                                input.type = 'text';
                                icon.classList.remove('fa-eye');
                                icon.classList.add('fa-eye-slash');
                            } else {
                                input.type = 'password';
                                icon.classList.remove('fa-eye-slash');
                                icon.classList.add('fa-eye');
                            }
                        } 
                    }); 
                });
                // --- END MODIFIED Password Toggle ---

                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => this.showPage(btn.dataset.page)));
                
                // Sidebar Navigation
                this.state.ui.menuToggleBtn.addEventListener('click', () => this.openSidebar());
                this.state.ui.sidebarOverlay.addEventListener('click', () => this.closeSidebar());
                document.querySelectorAll('#app-sidebar .action-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.showPage(card.dataset.pageTarget);
                    });
                });
                this.state.ui.sidebarLogoutBtn?.addEventListener('click', (e) => this.handleLogout(e));
                
                // Sub-page back buttons
                document.querySelectorAll('.page-header .back-btn').forEach(btn => btn.addEventListener('click', () => this.showPage(btn.dataset.target)));

                // Modals
                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => this.hideModal(btn.dataset.modalId)));
                document.getElementById('recharge-btn-modal').addEventListener('click', () => this.showModal('recharge-modal'));
                document.getElementById('withdraw-btn-modal').addEventListener('click', () => this.showModal('withdrawal-modal'));
                
                // Core Features
                this.state.ui.rechargeForm.addEventListener('submit', (e) => this.handleRecharge(e));
                this.state.ui.withdrawalForm.addEventListener('submit', (e) => this.handleWithdraw(e));
                
                // Plan Purchase
                this.state.ui.marketingPlansContainer.addEventListener('click', e => {
                    const btn = e.target.closest('.btn-purchase-plan');
                    if (btn) this.openPlanPurchaseModal(btn.dataset.planId);
                });
                this.state.ui.planPurchaseForm.addEventListener('submit', e => this.handlePlanPurchase(e));
                this.state.ui.claimPlanProfitBtn.addEventListener('click', e => this.handleClaimPlanProfit(e));
                // NEW: Upgrade Plan Button Handler
                this.state.ui.upgradePlanBtn.addEventListener('click', e => {
                    const plansPanel = this.state.ui.marketingPlansPanel;
                    plansPanel.scrollIntoView({ behavior: 'smooth' });
                    // Optionally highlight the plans panel
                    plansPanel.style.border = '3px solid var(--tertiary-accent)';
                    setTimeout(() => plansPanel.style.border = '1px solid var(--surface-border)', 1500);
                });


                // Buttons and Inputs
                this.state.ui.changePasswordForm.addEventListener('submit', e => this.handleChangePassword(e));
                document.getElementById('copy-invite-link-btn').addEventListener('click', (e) => this.copyToClipboard(this.state.ui.inviteLinkDisplay.innerText, e.currentTarget));
                document.querySelectorAll('.address-box .copy-btn').forEach(btn => { 
                    btn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        const targetId = btn.dataset.copyTargetId; 
                        const textToCopy = document.getElementById(targetId)?.innerText; 
                        if (textToCopy) this.copyToClipboard(textToCopy, btn.closest('.address-box')); 
                    }); 
                });
                
                // Block/Network Click Handler (Dynamic Level Cards added in renderNetworkDiagram)
                this.state.ui.collectBonusBtn.addEventListener('click', e => this.handleCollectInviteBonus(e));


                // NFT Event Listeners
                this.state.ui.viewMyNftsBtn.addEventListener('click', () => this.showPage('my-nfts-page'));
                this.state.ui.nftGridContainer.addEventListener('click', e => {
                    if (e.target.matches('.btn-buy-nft, .btn-buy-nft *')) {
                        const btn = e.target.closest('.btn-buy-nft');
                        this.handleBuyNft(btn);
                    }
                });
                this.state.ui.myNftsList.addEventListener('click', e => {
                    if (e.target.matches('.btn-claim-nft, .btn-claim-nft *')) {
                        const btn = e.target.closest('.btn-claim-nft');
                        this.handleClaimNftProfit(btn.dataset.nftKey, btn);
                    }
                });
            },
            
            initLandingPageAnimations() {
                const sections = document.querySelectorAll('.landing-section');
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.1 });
                sections.forEach(section => observer.observe(section));
            },

            checkForRefCode() { const refCode = new URLSearchParams(window.location.search).get('ref'); if (refCode) { this.state.ui.registerRefCodeInput.value = refCode; } },
            
            // --- [5] CORE LOGIC ---
            handleAuth() { 
                this.auth.onAuthStateChanged(user => { 
                    this.hidePreloader(); 
                    if (user) { 
                        this.state.currentUser = user; 
                        this.listenToUserData(); 
                        this.state.ui.landingPageContainer.style.display = 'none';
                        this.state.ui.body.classList.remove('landing-visible');
                        this.state.ui.authContainer.classList.remove('active'); 
                        this.state.ui.appContainer.classList.add('active'); 
                        this.state.ui.appHeader.style.display = 'flex'; 
                        this.showPage('home-page'); 
                    } else { 
                        this.state.currentUser = null; 
                        this.state.userData = null; 
                        this.stopAllListeners(); 
                        this.state.ui.appHeader.style.display = 'none'; 
                        this.state.ui.landingPageContainer.style.display = 'block';
                        this.state.ui.body.classList.add('landing-visible');
                        this.state.ui.authContainer.classList.remove('active'); 
                        this.state.ui.appContainer.classList.remove('active'); 
                    } 
                }); 
            },
            
            async handleRegister(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                this.setButtonLoading(btn, true);
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const repeatPassword = document.getElementById('register-repeat-password').value;
                const refCode = this.state.ui.registerRefCodeInput.value.trim();

                if (password !== repeatPassword) { this.showToast('Passwords do not match.', 'danger'); this.setButtonLoading(btn, false); return; }
                if (password.length < 6) { this.showToast('Password should be at least 6 characters.', 'danger'); this.setButtonLoading(btn, false); return; }

                try {
                    let referrerData = null;
                    let ancestry = {};
                    if(refCode) {
                        const referrerSnap = await this.db.ref('users').orderByChild('referralCode').equalTo(refCode).once('value');
                        if (referrerSnap.exists()) {
                            const referrerUid = Object.keys(referrerSnap.val())[0];
                            referrerData = referrerSnap.val()[referrerUid];
                            ancestry['level_1'] = referrerUid;
                            // Level 1 is Direct. Indirect starts at Level 2.
                            if(referrerData.ancestry){
                                // Iterate up to the new REFERRAL_LEVELS (9 indirect levels) + 1 direct level = 10 total levels (level 10 in DB is the 9th indirect level)
                                for(let i = 1; i < this.config.REFERRAL_LEVELS + 1; i++){ 
                                    if(referrerData.ancestry[`level_${i}`]){
                                        ancestry[`level_${i + 1}`] = referrerData.ancestry[`level_${i}`];
                                    } else { break; }
                                }
                            }
                        } else { this.showToast('Invalid invitation code.', 'warning'); }
                    }

                    const userCredential = await this.auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const referralCode = 'CDNC' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    await this.db.ref('users/' + user.uid).set({
                        username, email, uid: user.uid, referralCode, referredBy: refCode || null,
                        usd_balance: 0, 
                        balance_on_hold: 0,
                        unclaimed_invite_bonus: 0, active_referrals_count: 0,
                        plans: { 
                            totalInvestmentUSD: 0, 
                            lastProfitClaimTimestamp: 0, 
                            firstInvestmentProcessed: false, // <-- GATES INVITATION BONUS EARNING
                            totalProfitGeneratedUSD: 0,
                            hasPlan20Pro: false 
                        }, 
                        nfts: {},
                        ancestry: ancestry,
                        referrals_by_level: {},
                        referrals_data: {},
                        miningGateActive: false, 
                        miningGateProgress: { activatedReferralsCount: 0, activatedReferralUIDs: {} }
                    });

                    if(Object.keys(ancestry).length > 0){
                        const updates = {};
                        for (const [level, ancestorUid] of Object.entries(ancestry)) {
                            const levelNum = parseInt(level.split('_')[1]);
                            updates[`${ancestorUid}/referrals_by_level/level_${levelNum}`] = firebase.database.ServerValue.increment(1);
                            updates[`${ancestorUid}/referrals_data/level_${levelNum}/${user.uid}`] = { username, email, joinedAt: firebase.database.ServerValue.TIMESTAMP, uid: user.uid };
                        }
                        await this.db.ref('users').update(updates);
                    }
                    
                    await user.updateProfile({ displayName: username });
                    this.showToast('Registration successful! Please log in.', 'success');
                    this.state.ui.registerForm.reset();
                    this.state.ui.registerPage.style.display = 'none';
                    this.state.ui.loginPage.style.display = 'block';
                } catch (error) { this.showToast(error.message, 'danger');
                } finally { this.setButtonLoading(btn, false); }
            },

            async handleLogin(e) { e.preventDefault(); const btn = e.target.querySelector('button'); this.setButtonLoading(btn, true); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await this.auth.signInWithEmailAndPassword(email, password); } catch (error) { this.showToast(error.message, 'danger'); } finally { this.setButtonLoading(btn, false); } },
            
            // NEW: Forgot Password Handler
            async handleForgotPassword(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                this.setButtonLoading(btn, true);
                const email = document.getElementById('reset-email').value.trim();

                try {
                    await this.auth.sendPasswordResetEmail(email);
                    this.showToast(`Password reset link sent to ${email}. Check your inbox!`, 'success');
                    this.hideModal('forgot-password-modal');
                    document.getElementById('forgot-password-form').reset();
                } catch (error) {
                    this.showToast(error.message, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            async handleLogout(e) { try { await this.auth.signOut(); } catch (error) { this.showToast(error.message, 'danger'); } },
            
            // MODIFIED handleRecharge for PKR - Sets status to 'pending'
            async handleRecharge(e) { 
                e.preventDefault(); 
                const btn = e.currentTarget.querySelector('button'); 
                const pkrAmount = parseFloat(document.getElementById('recharge-amount').value); 
                const senderAccount = document.getElementById('sender-account-number').value.trim();
                const txId = document.getElementById('transaction-id').value.trim(); 
                
                // Hardcoded to Easypaisa
                const network = 'easypaisa';
                
                if (!txId || !senderAccount || isNaN(pkrAmount) || pkrAmount <= 0) {
                    return this.showToast('Please provide valid PKR amount, Sender Account, and Transaction ID.', 'danger'); 
                }
                if (!/^\d{11}$/.test(senderAccount)) {
                    return this.showToast('Sender Account Number must be 11 digits.', 'danger'); 
                }
                
                this.setButtonLoading(btn, true); 
                
                const usdEquivalent = pkrAmount / this.config.PKR_TO_USD_RATE;

                try { 
                    await this.db.ref('recharge_requests').push({ 
                        userId: this.state.currentUser.uid, 
                        userEmail: this.state.currentUser.email, 
                        pkrAmount: pkrAmount,
                        usdEquivalent: usdEquivalent,
                        network, 
                        txId, 
                        senderAccount,
                        status: 'pending', 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    }); 

                    // Log transaction with pending status for history view
                    await this.logTransaction('deposit', usdEquivalent, { network, txId, senderAccount, pkrAmount, status: 'pending' }); 
                    
                    this.showToast(`Recharge request for PKR ${pkrAmount.toLocaleString()} submitted! Admin will process it shortly.`, 'success'); 
                    this.state.ui.rechargeForm.reset(); 
                    this.hideModal('recharge-modal'); 
                } catch (err) { 
                    this.showToast(`Request failed: ${err.message}`, 'danger'); 
                } finally { 
                    this.setButtonLoading(btn, false); 
                } 
            },

            // MODIFIED handleWithdraw for PKR - Sets status to 'pending'
            async handleWithdraw(e) { 
                e.preventDefault(); 
                const btn = e.currentTarget.querySelector('button'); 
                const pkrAmount = parseFloat(document.getElementById('withdraw-amount').value); 
                const network = document.getElementById('withdraw-network').value;
                const accountNumber = document.getElementById('withdraw-account-number').value.trim();
                const accountHolderName = document.getElementById('withdraw-account-holder-name').value.trim();
                
                if (isNaN(pkrAmount) || pkrAmount <= 0 || !accountNumber || !network || !accountHolderName) {
                    return this.showToast('Please fill all fields.', 'danger'); 
                }
                if (!/^\d{11}$/.test(accountNumber)) {
                    return this.showToast('Account Number must be 11 digits.', 'danger'); 
                }

                const usdAmount = pkrAmount / this.config.PKR_TO_USD_RATE;
                const fee = usdAmount * this.config.WITHDRAWAL_FEE_PERCENT;
                const netUsdWithdrawal = usdAmount + fee; // The amount to deduct from balance

                if (this.state.userData.usd_balance < netUsdWithdrawal) {
                    return this.showToast(`Insufficient balance. Required USD: $${netUsdWithdrawal.toFixed(2)}.`, 'danger'); 
                }
                
                this.setButtonLoading(btn, true); 
                
                try { 
                    // Move funds to balance_on_hold immediately
                    await this.state.userRef.update({ 
                        usd_balance: firebase.database.ServerValue.increment(-netUsdWithdrawal), 
                        balance_on_hold: firebase.database.ServerValue.increment(netUsdWithdrawal) 
                    }); 
                    
                    await this.db.ref('withdrawal_requests').push({ 
                        userId: this.state.currentUser.uid, 
                        userEmail: this.state.currentUser.email, 
                        pkrAmount: pkrAmount,
                        usdAmount: usdAmount,
                        fee: fee, 
                        network, 
                        accountNumber, 
                        accountHolderName,
                        status: 'pending', 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    }); 

                    // Log transaction with pending status for history view
                    await this.logTransaction('withdrawal', usdAmount, { 
                        network, 
                        accountNumber, 
                        accountHolderName,
                        pkrAmount,
                        fee, 
                        status: 'pending' 
                    }); 

                    this.showToast(`Withdrawal request for PKR ${pkrAmount.toLocaleString()} submitted! Admin will process it shortly.`, 'success'); 
                    this.state.ui.withdrawalForm.reset(); 
                    this.hideModal('withdrawal-modal'); 
                } catch (err) { 
                    this.showToast(`Withdrawal failed: ${err.message}`, 'danger'); 
                    // Rollback on client-side failure (return funds from hold to balance)
                    await this.state.userRef.update({ 
                        usd_balance: firebase.database.ServerValue.increment(netUsdWithdrawal), 
                        balance_on_hold: firebase.database.ServerValue.increment(-netUsdWithdrawal) 
                    });
                } finally { 
                    this.setButtonLoading(btn, false); 
                } 
            },
            
            // --- [5.1] Plan & Invitation Bonus Logic (Modified Daily Rate) ---
            
            updatePlansUI() {
                const container = this.state.ui.marketingPlansContainer;
                container.innerHTML = ''; 
                this.config.MARKETING_PLANS.forEach(plan => {
                    const card = document.createElement('div');
                    card.className = 'plan-card';
                    const isPlan20 = plan.id === this.config.PLAN_20_ID;
                    const iconColor = isPlan20 ? 'var(--danger-color)' : (plan.id % 2 === 0 ? 'var(--primary-accent)' : 'var(--secondary-accent)');
                    const dailyRateText = isPlan20 ? '5%' : '0%';
                    
                    card.innerHTML = `
                        <div class="plan-visual" style="box-shadow: 0 0 15px ${iconColor}; background: linear-gradient(45deg, ${iconColor}, var(--secondary-accent));">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h4>${plan.name}</h4>
                        <p class="plan-price">PKR ${plan.pkrCost.toLocaleString()} | $${plan.usdCost.toFixed(2)} USD</p>
                        <ul class="nft-details" style="border-left: 5px solid ${iconColor};">
                            <li><span>Daily Earning</span><span>${dailyRateText}</span></li>
                            <li><span>Duration</span><span>${plan.duration}</span></li>
                        </ul>
                        <button class="btn btn-purchase-plan" data-plan-id="${plan.id}" data-plan-usd-cost="${plan.usdCost}" style="${isPlan20 ? 'background: linear-gradient(45deg, var(--danger-color), #f87171); border-radius: 14px;' : 'border-radius: 14px;'}">
                            <span class="btn-text">Purchase Plan</span>
                        </button>
                    `;
                    container.appendChild(card);
                });
            },

            openPlanPurchaseModal(planId) {
                const plan = this.config.MARKETING_PLANS.find(p => p.id == planId);
                if (!plan) return this.showToast('Plan not found.', 'danger');
                
                const usd_balance = this.state.userData.usd_balance || 0;
                const pkr_balance = usd_balance * this.config.PKR_TO_USD_RATE;

                // Pre-check for balance before showing modal
                if (plan.usdCost > usd_balance) { 
                    return this.showToast('Insufficient USD balance to purchase this plan. Please recharge.', 'danger');
                }
                
                this.state.ui.planModalTitle.textContent = `Confirm Purchase: ${plan.name}`;
                this.state.ui.planModalName.textContent = plan.name;
                
                this.state.ui.planModalUsdBalance.textContent = `$${usd_balance.toFixed(2)}`;
                this.state.ui.planModalPkrBalance.textContent = `PKR ${Math.round(pkr_balance).toLocaleString()}`; 
                
                this.state.ui.planCostDisplay.value = `PKR ${plan.pkrCost.toLocaleString()} / $${plan.usdCost.toFixed(2)} USD`;
                this.state.ui.planPurchaseUsdCost.value = plan.usdCost;
                this.state.ui.planPurchasePlanId.value = plan.id; // Store ID for logic

                const hasActivePlan = (this.state.userData.plans?.totalInvestmentUSD || 0) > 0;
                this.state.ui.confirmPlanPurchaseBtn.querySelector('.btn-text').textContent = hasActivePlan ? 'Confirm & Upgrade' : 'Confirm & Purchase';
                this.showModal('plan-purchase-modal');
            },
            
            async handlePlanPurchase(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const planId = parseInt(this.state.ui.planPurchasePlanId.value);
                const amount = parseFloat(this.state.ui.planPurchaseUsdCost.value);
                const plan = this.config.MARKETING_PLANS.find(p => p.id == planId);
                
                if (!plan || isNaN(amount) || amount <= 0) { return this.showToast('Invalid plan data.', 'danger'); }
                if (amount > this.state.userData.usd_balance) { 
                    this.showToast('Insufficient USD balance.', 'danger'); 
                    this.setButtonLoading(btn, false);
                    return;
                }
                
                this.setButtonLoading(btn, true);
                
                try {
                    const plansData = this.state.userData.plans || {};
                    const isFirstInvestment = !(plansData.firstInvestmentProcessed); // For bonus gating
                    
                    const updates = {
                        'usd_balance': firebase.database.ServerValue.increment(-amount), 
                        'plans/totalInvestmentUSD': firebase.database.ServerValue.increment(amount),
                        // Reset claim time to now on any new investment/upgrade
                        'plans/lastProfitClaimTimestamp': firebase.database.ServerValue.TIMESTAMP 
                    };

                    // Check if the purchased plan is Plan 20 Pro and update the flag
                    if(planId === this.config.PLAN_20_ID) {
                        updates['plans/hasPlan20Pro'] = true;
                    } else if (plansData.hasPlan20Pro) {
                         // If a user buys a lower plan after Plan 20, they lose the 5% override
                         updates['plans/hasPlan20Pro'] = false;
                    }

                    await this.state.userRef.update(updates);
                    
                    // Must be called AFTER the investment is successfully processed
                    if (isFirstInvestment) { 
                        // **This is the logic that gates the invitation bonus earning**
                        await this.processFirstInvestmentAndReferrals(amount); 
                    }
                    
                    await this.logTransaction('plan_invest', amount, { reason: `Purchased ${plan.name} Plan`, status: 'approved' });
                    this.showToast(`Purchased ${plan.name} Plan for $${amount.toFixed(2)}! Earning is now active!`, 'success');
                    this.hideModal('plan-purchase-modal');
                } catch (error) { 
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally { 
                    this.setButtonLoading(btn, false); 
                }
            },
            
            // MODIFIED: Only Plan 20 Pro (5%) earns daily profit, all others are 0%
            getEffectiveDailyRate() {
                const planData = this.state.userData?.plans;
                
                if (!planData || planData.totalInvestmentUSD <= 0) {
                    return 0;
                }

                // Special case: Plan 20 Pro gives 5% unconditionally
                if (planData.hasPlan20Pro) {
                    return this.config.PLAN_DAILY_RATE_PRO_PERCENT; // 0.05
                }

                // All other plans have a 0% non-working rate
                return 0; 
            },
            
            async handleClaimPlanProfit(e) {
                const btn = e.currentTarget;
                const profitUSD = this.calculatePlanProfit(); 
                
                if (profitUSD < this.config.MINIMUM_PROFIT_CLAIM_USD) {
                    return this.showToast("Profit is too low to claim.", "info");
                }
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.transaction(data => {
                        if (data && data.plans) {
                            data.usd_balance = (data.usd_balance || 0) + profitUSD; 
                            data.plans.lastProfitClaimTimestamp = firebase.database.ServerValue.TIMESTAMP;
                            data.plans.totalProfitGeneratedUSD = (data.plans.totalProfitGeneratedUSD || 0) + profitUSD;
                        }
                        return data;
                    });
                    await this.logTransaction('plan_profit', profitUSD, { status: 'approved' }); // Plan profit is instantly approved
                    this.showToast(`Claimed $${profitUSD.toFixed(6)} USD!`, 'success');
                } catch(error) {
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            calculatePlanProfit(planData = this.state.userData?.plans) {
                if (!planData?.totalInvestmentUSD || !planData.lastProfitClaimTimestamp) return 0;
                
                const effectiveDailyRate = this.getEffectiveDailyRate();
                if (effectiveDailyRate === 0) return 0; // User is not in an earning state

                const elapsedMs = Date.now() - planData.lastProfitClaimTimestamp;
                if (elapsedMs <= 0) return 0;
                
                const potentialProfitUSD = (elapsedMs / 86400000) * (planData.totalInvestmentUSD * effectiveDailyRate);
                
                return potentialProfitUSD;
            },

            updatePlanUI() {
                if(this.state.planProfitInterval) clearInterval(this.state.planProfitInterval);
                const planData = this.state.userData?.plans;
                
                if (planData && planData.totalInvestmentUSD > 0) {
                    this.state.ui.activePlanStatus.style.display = 'block';
                    
                    const investment = planData.totalInvestmentUSD;
                    const effectiveDailyRate = this.getEffectiveDailyRate();

                    let rateText;
                    let dailyProfitValue = investment * effectiveDailyRate;

                    if (effectiveDailyRate === this.config.PLAN_DAILY_RATE_PRO_PERCENT) {
                        rateText = `$${dailyProfitValue.toFixed(4)} USD (5% Pro)`;
                    } else {
                        // All other plans have 0% daily earning
                        rateText = `$0.00 USD (0%)`;
                    }

                    // Update UI elements
                    this.state.ui.planInvestmentValue.textContent = `$${investment.toFixed(2)}`;
                    this.state.ui.planProfitRate.textContent = rateText; 
                    
                    // Hide/remove the irrelevant 'Active Refs for 3%' UI if it existed
                    // Note: The template was cleaned up, this only ensures the correct rateText is shown

                    this.state.planProfitInterval = setInterval(() => {
                        const accumulatedProfit = this.calculatePlanProfit(); 
                        this.state.ui.planAccumulatedProfit.textContent = `$${accumulatedProfit.toFixed(8)} USD`;
                        this.state.ui.claimPlanProfitBtn.disabled = accumulatedProfit < dailyProfitValue; // Only allow claim after 1 day's profit is generated
                        this.state.ui.claimPlanProfitBtn.querySelector('.btn-text').innerHTML = `<i class="fas fa-hand-holding-dollar"></i> Claim Profit`;
                        
                        if (effectiveDailyRate === 0) { // Override: If no profit, keep button disabled
                            this.state.ui.claimPlanProfitBtn.disabled = true;
                            this.state.ui.claimPlanProfitBtn.querySelector('.btn-text').innerHTML = `No Daily Earning`;
                        }
                    }, 1000);

                } else {
                    this.state.ui.activePlanStatus.style.display = 'none';
                }
            },

            // --- [5.2] Ranking Logic (Kept as is) ---
            calculateUserNetWorth(userData) {
                const usdBalance = userData.usd_balance || 0;
                const planInvestment = userData.plans?.totalInvestmentUSD || 0;
                const planProfit = userData.plans?.totalProfitGeneratedUSD || 0;
                let nftValue = 0;
                if (userData.nfts) {
                    Object.values(userData.nfts).forEach(nft => {
                        nftValue += (nft.investment || 0) + (nft.totalProfitClaimed || 0);
                    });
                }
                const netWorth = usdBalance + planInvestment + planProfit + nftValue;
                return netWorth;
            },
            
            // MODIFIED: Simple Rank Display
            getRankDisplay(rank) {
                if (rank <= 0) return 'N/A';
                return `#${rank}`;
            },

            updateRankingUI() {
                const rankedUsers = this.state.allUsersData;
                const rankingList = this.state.ui.rankingList;
                const currentUserUid = this.state.currentUser?.uid;
                
                rankingList.innerHTML = '';
                if (rankedUsers.length === 0) {
                    rankingList.innerHTML = '<p class="info-text" id="no-ranking-msg">No ranking data available yet. Start investing to see your rank!</p>';
                    return;
                }

                const topUsers = rankedUsers.slice(0, this.config.RANKING_LIMIT);
                
                // Hide the "No data" message
                document.getElementById('no-ranking-msg')?.remove();

                topUsers.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = user.uid === currentUserUid;
                    const item = document.createElement('li');
                    item.className = 'ranking-item';
                    if (isCurrentUser) item.style.borderLeftColor = 'var(--primary-accent)';
                    if (rank <= 3) item.style.background = 'var(--surface-highlight)';
                    
                    const rankDisplay = this.getRankDisplay(rank);
                    const rankClass = rank <= 3 ? 'top-3' : ''; 

                    const usernameDisplay = user.username || this.maskEmail(user.email);

                    item.innerHTML = `
                        <div class="rank-num ${rankClass}">${rankDisplay}</div>
                        <div class="user-info" style="width: 40%;">
                            <div class="username">${usernameDisplay} ${isCurrentUser ? '(You)' : ''}</div>
                            <div class="uid">${user.uid.slice(0, 8)}...</div>
                        </div>
                        <div class="net-worth" style="width: 45%;">$${user.netWorth.toFixed(2)}</div>
                    `;
                    rankingList.appendChild(item);
                });

                if (this.state.userData && currentUserUid) {
                    const myRankIndex = rankedUsers.findIndex(u => u.uid === currentUserUid);
                    const myNetWorth = this.calculateUserNetWorth(this.state.userData);
                    this.state.ui.myNetWorthValue.textContent = `$${myNetWorth.toFixed(2)}`;
                    this.state.ui.myGlobalRankValue.textContent = myRankIndex !== -1 ? `${myRankIndex + 1} / ${rankedUsers.length}` : 'N/A';
                    this.state.ui.myGlobalRankValue.style.color = myRankIndex !== -1 && myRankIndex < 10 ? 'var(--tertiary-accent)' : 'var(--warning-color)';
                }
            },
            
            // --- [5.3] Profile, Tasks, Rewards & Network Logic (Kept as is) ---
            
            async handleChangePassword(e) { e.preventDefault(); const btn = e.target.querySelector('button'); this.setButtonLoading(btn, true); const currentPassword = document.getElementById('current-password').value; const newPassword = document.getElementById('new-password').value; if (newPassword.length < 6) { this.showToast('New password must be at least 6 characters.', 'danger'); this.setButtonLoading(btn, false); return; } try { const user = this.state.currentUser; await user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, currentPassword)); await user.updatePassword(newPassword); this.showToast('Password changed successfully!', 'success'); this.state.ui.changePasswordForm.reset(); this.showPage('profile-page'); } catch (error) { this.showToast(error.message, 'danger'); } finally { this.setButtonLoading(btn, false); } },
            // Log transaction with status detail
            async logTransaction(type, amount, details = {}) { if(!this.state.currentUser) return; await this.db.ref(`transactions/${this.state.currentUser.uid}`).push({ type, amount, details, timestamp: firebase.database.ServerValue.TIMESTAMP }); },

            // MODIFIED: Function to update the referral bonus UI AND render the dynamic network cards
            updateNetworkUI() {
                const unclaimedBonus = this.state.userData.unclaimed_invite_bonus || 0;
                this.state.ui.unclaimedBonusAmount.textContent = `$${unclaimedBonus.toFixed(4)}`;
                this.state.ui.collectBonusBtn.disabled = unclaimedBonus <= 0;
                
                this.renderNetworkDiagram();
            },

            // NEW: Renders the vertical, card-based dynamic network structure
            renderNetworkDiagram() {
                const container = this.state.ui.networkLevelsContainer;
                const referralsByLevel = this.state.userData.referrals_by_level || {};
                const totalLevels = this.config.REFERRAL_LEVELS + 1; // 1 Direct + 9 Indirect = 10 Levels
                container.innerHTML = '';

                if (Object.keys(referralsByLevel).length === 0) {
                     container.innerHTML = '<p class="info-text" style="text-align: center;">Your network map will appear here after your first referral joins and invests.</p>';
                     return;
                }

                for (let i = 1; i <= totalLevels; i++) {
                    const levelKey = `level_${i}`;
                    const count = referralsByLevel[levelKey] || 0;
                    const levelType = i === 1 ? 'Direct' : `Indirect L${i-1}`;
                    const blockClass = i === 1 ? 'direct' : 'indirect';
                    const bonus = i === 1 ? (this.config.REFERRAL_DIRECT_BONUS_PERCENT * 100) : (this.config.REFERRAL_INDIRECT_BONUS_PERCENT * 100);
                    
                    const card = document.createElement('div');
                    card.className = `network-level-card ${blockClass}`;
                    card.dataset.level = i;
                    card.style.opacity = count > 0 ? '1' : '0.5'; // Dim levels with no members
                    card.addEventListener('click', () => this.showBlockListModal(i));

                    card.innerHTML = `
                        <h4><i class="fas fa-cubes" style="margin-right: 8px;"></i> Block Level ${i} (${levelType})</h4>
                        <div class="stat-info">
                            <div>
                                <div class="stat-value" style="color: ${count > 0 ? 'var(--primary-accent)' : 'var(--text-secondary)'}">${count}</div>
                                <div class="stat-label">Total Members</div>
                            </div>
                            <div>
                                <div class="stat-value" style="color: var(--success-color);">${bonus.toFixed(0)}%</div>
                                <div class="stat-label">Commission Rate</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            },
            
            // NEW: Logic to show all members for a clicked level
            async showBlockListModal(level) {
                const modal = this.state.ui.blockListModal;
                const modalTitle = this.state.ui.blockListModalTitle;
                const modalBody = this.state.ui.blockListModalBody;
                const memberData = this.state.userData.referrals_data?.[`level_${level}`];
                const levelType = level === 1 ? 'Direct Block' : `Indirect Block L${level-1}`;
                
                modalTitle.textContent = `${levelType} Members (Level ${level})`;
                modalBody.innerHTML = '';
                
                if (!memberData || Object.keys(memberData).length === 0) {
                    modalBody.innerHTML = '<p class="info-text">No members found at this block level yet. Invite new users to grow your network!</p>';
                    this.showModal('block-list-modal');
                    return;
                }

                const members = Object.values(memberData).sort((a, b) => b.joinedAt - a.joinedAt);

                members.forEach(member => {
                    const item = document.createElement('li');
                    item.className = 'modal-member-item';
                    const usernameDisplay = member.username || this.maskEmail(member.email);
                    const joinedDate = new Date(member.joinedAt).toLocaleDateString();

                    item.innerHTML = `
                        <div class="user-icon"><i class="fas fa-user-circle"></i></div>
                        <div class="member-details">
                            <div class="username-label">${usernameDisplay}</div>
                            <div class="email-label">UID: ${member.uid.slice(0, 8)}...</div>
                        </div>
                        <div class="joined-date">Joined: ${joinedDate}</div>
                    `;
                    modalBody.appendChild(item);
                });

                this.showModal('block-list-modal');
            },


            async handleCollectInviteBonus(e) {
                const btn = e.currentTarget;
                const unclaimedBonus = this.state.userData.unclaimed_invite_bonus || 0;
                if (unclaimedBonus <= 0) return;
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.update({
                        usd_balance: firebase.database.ServerValue.increment(unclaimedBonus),
                        unclaimed_invite_bonus: 0
                    });
                    // Log transaction with approved status
                    await this.logTransaction('invite_bonus', unclaimedBonus, { reason: 'Block Commission', status: 'approved' }); 
                    this.showToast(`Collected $${unclaimedBonus.toFixed(4)} from your network!`, 'success');
                } catch (error) {
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },
            
            // UPDATED FREE MINING UI LOGIC (Simplified since gate is gone)
            updateFreeMiningUI() {
                const activeReferrals = this.state.userData.active_referrals_count || 0;
                this.state.ui.freeMiningProgress.textContent = `${activeReferrals} / ${this.config.FREE_PLAN_REQUIRED_REFERRALS}`;
            },
            
            // --- [5.4] NFT Logic (Kept as is) ---
            
            canUserBuyNFT() {
                return (this.state.userData.active_referrals_count || 0) >= this.config.NFT_REQUIRED_ACTIVE_REFERRALS;
            },

            updateNFTRequirementUI() {
                const canBuy = this.canUserBuyNFT();
                const activeRefs = this.state.userData.active_referrals_count || 0;
                const requiredRefs = this.config.NFT_REQUIRED_ACTIVE_REFERRALS;
                const panel = this.state.ui.nftRequirementPanel;
                const grid = this.state.ui.nftGridContainer;
                
                panel.innerHTML = `
                    <div class="invite-box">
                        <div class="icon" style="color: ${canBuy ? 'var(--success-color)' : 'var(--danger-color)'}; text-shadow: 0 0 20px ${canBuy ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'};">
                            <i class="fas ${canBuy ? 'fa-lock-open' : 'fa-lock'}"></i>
                        </div>
                        <h3 style="background: none; -webkit-text-fill-color: ${canBuy ? 'var(--success-color)' : 'var(--danger-color)'}; border-bottom: none;">NFT Access Status: ${canBuy ? 'UNLOCKED' : 'LOCKED'}</h3>
                        <p>Requirement: To purchase any NFT, you must have <b>${requiredRefs} direct members</b> who have made their first investment.</p>
                        <div class="stat-card" style="margin: 20px 0;">
                            <div class="label">Your Active Direct Referrals</div>
                            <div class="value" style="color: ${canBuy ? 'var(--success-color)' : 'var(--warning-color)'};">${activeRefs} / ${requiredRefs}</div>
                        </div>
                    </div>
                `;
                
                // Disable/Enable the grid and buttons
                grid.style.opacity = canBuy ? '1' : '0.4';
                grid.style.pointerEvents = canBuy ? 'auto' : 'none';
                
                document.querySelectorAll('.btn-buy-nft').forEach(btn => {
                    btn.disabled = !canBuy;
                    btn.querySelector('.btn-text').textContent = canBuy ? 'Buy Now' : 'Locked';
                });
            },

            async handleBuyNft(btn) {
                const { nftId, min, max } = btn.dataset;
                const card = btn.closest('.nft-card');
                const amountInput = card.querySelector('.nft-buy-amount');
                const amount = parseFloat(amountInput.value);

                if (!this.canUserBuyNFT()) {
                     this.setButtonLoading(btn, false);
                     return this.showToast(`NFT purchase is locked. You need ${this.config.NFT_REQUIRED_ACTIVE_REFERRALS} active direct members.`, 'danger');
                }

                if (isNaN(amount)) return this.showToast('Please enter a valid amount.', 'danger');
                if (amount < min || amount > max) return this.showToast(`Amount must be between $${min} and $${max}.`, 'danger');
                if (amount > (this.state.userData.usd_balance || 0)) return this.showToast('Insufficient USD balance.', 'danger');
                
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.child('usd_balance').set(firebase.database.ServerValue.increment(-amount));
                    await this.state.userRef.child('nfts').push({
                        nftId: nftId,
                        investment: amount,
                        purchaseTimestamp: firebase.database.ServerValue.TIMESTAMP,
                        lastClaimTimestamp: firebase.database.ServerValue.TIMESTAMP,
                        totalProfitClaimed: 0,
                    });
                    // Log NFT purchase with approved status
                    await this.logTransaction('nft_purchase', amount, { reason: `${nftId.charAt(0).toUpperCase() + nftId.slice(1)} NFT`, status: 'approved' });
                    this.showToast(`Successfully purchased ${nftId} NFT!`, 'success');
                    amountInput.value = '';
                } catch (error) {
                    this.showToast(`Purchase failed: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            updateMyNftsUI() {
                Object.values(this.state.nftIntervals).forEach(clearInterval);
                this.state.nftIntervals = {};
                const userNfts = this.state.userData?.nfts || {};
                const nftKeys = Object.keys(userNfts);

                if (nftKeys.length === 0) {
                    this.state.ui.myNftsList.innerHTML = '';
                    this.state.ui.noNftsMsg.style.display = 'block';
                    return;
                }

                this.state.ui.noNftsMsg.style.display = 'none';
                this.state.ui.myNftsList.innerHTML = '';

                nftKeys.forEach(key => {
                    const nft = userNfts[key];
                    const nftNames = { bronze: 'Bronze Miner', silver: 'Silver Prospector', gold: 'Gold Titan' };
                    const cardColors = { bronze: '#cd7f32', silver: '#c0c0c0', gold: '#FFC300' };

                    const card = document.createElement('div');
                    card.className = 'my-nft-card';
                    card.style.borderLeftColor = cardColors[nft.nftId] || 'var(--primary-accent)';
                    card.innerHTML = `
                        <div class="my-nft-card-header">
                            <h4>${nftNames[nft.nftId] || 'NFT'}</h4>
                            <span class="investment" style="color: ${cardColors[nft.nftId]}">$${nft.investment.toFixed(2)}</span>
                        </div>
                        <div class="nft-profit-details">
                            <div>
                                <div class="label">Total Claimed</div>
                                <div class="value" id="claimed-${key}">$${nft.totalProfitClaimed.toFixed(4)}</div>
                            </div>
                             <div>
                                <div class="label">Claimable Now</div>
                                <div class="value" id="claimable-${key}" style="color: var(--success-color);">...</div>
                            </div>
                        </div>
                         <div class="nft-timer" id="timer-${key}">Calculating...</div>
                         <div>
                            <div class="label">Total Return Progress (300%)</div>
                            <div class="nft-progress-bar">
                                <div class="nft-progress-bar-inner" id="progress-${key}" style="width: 0%;"></div>
                            </div>
                        </div>
                        <button class="btn btn-claim btn-claim-nft full-width" data-nft-key="${key}" disabled style="border-radius: 14px;">
                            <span class="btn-text">Claim Profit</span>
                            <div class="spinner-sm"></div>
                        </button>`;
                    this.state.ui.myNftsList.appendChild(card);
                    this.state.nftIntervals[key] = setInterval(() => this.updateSingleNftCard(key), 1000);
                });
            },

            updateSingleNftCard(key) {
                const nft = this.state.userData?.nfts?.[key];
                if (!nft) {
                    clearInterval(this.state.nftIntervals[key]);
                    return;
                }

                const claimableEl = document.getElementById(`claimable-${key}`);
                const timerEl = document.getElementById(`timer-${key}`);
                const progressEl = document.getElementById(`progress-${key}`);
                const claimBtn = document.querySelector(`.btn-claim-nft[data-nft-key="${key}"]`);

                if (!claimableEl || !timerEl || !progressEl || !claimBtn) {
                     clearInterval(this.state.nftIntervals[key]);
                     return;
                }

                const dailyProfit = nft.investment * this.config.NFT_DAILY_RATE_PERCENT;
                const totalReturnCap = nft.investment * this.config.NFT_TOTAL_RETURN_PERCENT;
                
                if (nft.totalProfitClaimed >= totalReturnCap) {
                    claimableEl.textContent = '$0.0000';
                    timerEl.textContent = 'Completed (300% Return Achieved)';
                    timerEl.style.color = 'var(--success-color)';
                    claimBtn.disabled = true;
                    claimBtn.querySelector('.btn-text').textContent = 'Completed';
                    progressEl.style.width = '100%';
                    clearInterval(this.state.nftIntervals[key]);
                    return;
                }

                const now = Date.now();
                const lastClaim = nft.lastClaimTimestamp;
                const timeSinceLastClaim = now - lastClaim;
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                let claimableAmount = (timeSinceLastClaim / twentyFourHours) * dailyProfit;
                claimableAmount = Math.min(claimableAmount, dailyProfit);
                claimableAmount = Math.min(claimableAmount, totalReturnCap - nft.totalProfitClaimed);
                
                claimableEl.textContent = `$${claimableAmount.toFixed(4)}`;
                const progressPercent = (nft.totalProfitClaimed / totalReturnCap) * 100;
                progressEl.style.width = `${progressPercent}%`;

                if (timeSinceLastClaim >= twentyFourHours) {
                    timerEl.textContent = 'Ready to Claim!';
                    timerEl.style.color = 'var(--success-color)';
                    claimBtn.disabled = false;
                } else {
                    const remaining = twentyFourHours - timeSinceLastClaim;
                    const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                    const minutes = Math.floor((remaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
                    timerEl.textContent = `Next claim in: ${hours}:${minutes}:${seconds}`;
                    timerEl.style.color = 'var(--warning-color)';
                    claimBtn.disabled = true;
                }
            },

            async handleClaimNftProfit(nftKey, btn) {
                const nft = this.state.userData?.nfts?.[nftKey];
                if (!nft) return this.showToast('NFT not found.', 'danger');

                const now = Date.now();
                const timeSinceLastClaim = now - nft.lastClaimTimestamp;
                const twentyFourHours = 24 * 60 * 60 * 1000;

                if (timeSinceLastClaim < twentyFourHours) {
                    return this.showToast('Not yet time to claim.', 'info');
                }
                
                this.setButtonLoading(btn, true);

                try {
                    const dailyProfit = nft.investment * this.config.NFT_DAILY_RATE_PERCENT;
                    const totalReturnCap = nft.investment * this.config.NFT_TOTAL_RETURN_PERCENT;
                    let profitToClaim = dailyProfit;

                    if (nft.totalProfitClaimed + profitToClaim > totalReturnCap) {
                        profitToClaim = totalReturnCap - nft.totalProfitClaimed;
                    }

                    if (profitToClaim <= 0) {
                        this.showToast('No profit left to claim.', 'info');
                        this.setButtonLoading(btn, false);
                        return;
                    }
                    
                    const updates = {};
                    updates[`/users/${this.state.currentUser.uid}/usd_balance`] = firebase.database.ServerValue.increment(profitToClaim);
                    updates[`/users/${this.state.currentUser.uid}/nfts/${nftKey}/totalProfitClaimed`] = firebase.database.ServerValue.increment(profitToClaim);
                    updates[`/users/${this.state.currentUser.uid}/nfts/${nftKey}/lastClaimTimestamp`] = firebase.database.ServerValue.TIMESTAMP;
                    
                    await this.db.ref().update(updates);
                    // Log NFT profit with approved status
                    await this.logTransaction('nft_profit', profitToClaim, { reason: `${nft.nftId} NFT Earning`, status: 'approved' });
                    
                    this.showToast(`Claimed $${profitToClaim.toFixed(4)}!`, 'success');

                } catch (error) {
                    this.showToast(`Claim failed: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            // --- [6] DATA LISTENERS (Kept as is) ---
            listenToUserData() { 
                if (!this.state.currentUser || this.state.userRef) return; 
                this.state.userRef = this.db.ref('users/' + this.state.currentUser.uid); 
                this.state.txRef = this.db.ref('transactions/' + this.state.currentUser.uid); 
                this.state.userRef.on('value', (snapshot) => { 
                    this.hidePreloader(); 
                    this.state.userData = snapshot.val(); 
                    if (this.state.userData) { 
                        this.updateUI(); 
                    } else { 
                        this.auth.signOut(); 
                    } 
                }, (error) => { 
                    console.error("Firebase user data error:", error); 
                    this.showToast("Could not sync user data.", "danger"); 
                }); 
                // Listen to the user's transactions for the history page, updated by admin changes to status
                this.state.txRef.limitToLast(100).on('value', (snapshot) => this.updateAllHistories(snapshot.val())); 
            },

            stopAllListeners() { 
                if (this.state.userRef) this.state.userRef.off(); 
                if (this.state.txRef) this.state.txRef.off(); 
                if(this.state.planProfitInterval) clearInterval(this.state.planProfitInterval); 
                Object.values(this.state.nftIntervals).forEach(clearInterval); 
                this.state.nftIntervals = {}; 
                this.state.userRef = null; 
                this.state.txRef = null; 
            },

            // --- [7] HELPERS (Kept as is) ---
            copyToClipboard(textToCopy, elementToUpdate = null) { if (!textToCopy) return; navigator.clipboard.writeText(textToCopy).then(() => { this.showToast('Copied!', 'success'); if (elementToUpdate) { const originalHTML = elementToUpdate.innerHTML; if(elementToUpdate.classList.contains('address-box')) { const icon = elementToUpdate.querySelector('.copy-btn i'); const originalIconClass = icon.className; elementToUpdate.classList.add('copied'); icon.className = 'fas fa-check'; setTimeout(() => { elementToUpdate.classList.remove('copied'); icon.className = originalIconClass; }, 2500); } else { elementToUpdate.innerHTML = `<span class="btn-text"><i class="fas fa-check"></i> Copied!</span>`; elementToUpdate.disabled = true; setTimeout(() => { elementToUpdate.innerHTML = originalHTML; elementToUpdate.disabled = false; }, 2000); } } }).catch(() => this.showToast('Failed to copy.', 'danger')); },
            initDraggableFAB() { const fab = this.state.ui.telegramFab; if (!fab) return; let isDragging = false, hasMoved = false, offsetX, offsetY; const getCoords = e => e.touches ? e.touches[0] : e; const start = e => { isDragging = true; hasMoved = false; fab.classList.add('dragging'); const c = getCoords(e); offsetX = c.clientX - fab.offsetLeft; offsetY = c.clientY - fab.offsetTop; document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, { passive: false }); document.addEventListener('mouseup', end); document.addEventListener('touchend', end); }; const move = e => { if (!isDragging) return; e.preventDefault(); hasMoved = true; const c = getCoords(e); fab.style.left = `${Math.max(0, Math.min(c.clientX - offsetX, window.innerWidth - fab.offsetWidth))}px`; fab.style.top = `${Math.max(0, Math.min(c.clientY - offsetY, window.innerHeight - fab.offsetHeight))}px`; fab.style.right = 'auto'; fab.style.bottom = 'auto'; }; const end = () => { isDragging = false; fab.classList.remove('dragging'); document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); }; fab.addEventListener('mousedown', start); fab.addEventListener('touchstart', start); fab.addEventListener('click', e => { if (hasMoved) e.preventDefault(); }); },
            maskEmail(email) {
                if (!email || email.indexOf('@') === -1) return email;
                const [name, domain] = email.split('@');
                if (name.length <= 2) return `${name.slice(0, 1)}***@${domain}`;
                return `${name.slice(0, 2)}***@${domain}`;
            },
        };

        window.App = App;
        App.init();
    });
    </script>
</body>
</html>
